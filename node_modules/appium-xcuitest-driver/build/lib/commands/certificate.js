'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _appiumIosDriver = require('appium-ios-driver');

var _appiumBaseDriver = require('appium-base-driver');

var _nodeSimctl = require('node-simctl');

var _asyncbox = require('asyncbox');

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _os = require('os');

var _os2 = _interopRequireDefault(_os);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _uuidJs = require('uuid-js');

var _uuidJs2 = _interopRequireDefault(_uuidJs);

var _teen_process = require('teen_process');

var extensions = {},
    commands = {};

var CONFIG_EXTENSION = 'mobileconfig';

function extractCommonName(certBuffer) {
  var tempCert, _ref, stdout, cnMatch;

  return _regeneratorRuntime.async(function extractCommonName$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_appiumSupport.tempDir.open({
          prefix: 'cert',
          suffix: '.cer'
        }));

      case 2:
        tempCert = context$1$0.sent;
        context$1$0.prev = 3;
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(tempCert.path, certBuffer));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)('openssl', ['x509', '-noout', '-subject', '-in', tempCert.path]));

      case 8:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;
        cnMatch = /\/CN=([^\s,]+)/.exec(stdout);

        if (!cnMatch) {
          context$1$0.next = 13;
          break;
        }

        return context$1$0.abrupt('return', cnMatch[1]);

      case 13:
        throw new Error('There is no common name value in \'' + stdout + '\' output');

      case 16:
        context$1$0.prev = 16;
        context$1$0.t0 = context$1$0['catch'](3);
        throw new Error('Cannot parse common name value from the certificate. Is it valid and base64-encoded? ' + ('Original error: ' + context$1$0.t0.message));

      case 19:
        context$1$0.prev = 19;
        context$1$0.next = 22;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(tempCert.path));

      case 22:
        return context$1$0.finish(19);

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[3, 16, 19, 23]]);
}

/**
 * Generates Apple's over-the-air configuration profile
 * for certificate deployment based on the given PEM certificate content.
 * Read https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/iPhoneOTAConfiguration/Introduction/Introduction.html
 * for more details on such profiles.
 *
 * @param {Buffer} certBuffer - The actual content of PEM certificate encoded into NodeJS buffer
 * @param {string} commonName - Certificate's common name
 * @returns {Object} The encoded structure of the given certificate, which is ready to be passed
 * as an argument to plist builder
 * @throws {Error} If the given certificate cannot be parsed
 */
function toMobileConfig(certBuffer, commonName) {
  var getUUID = function getUUID() {
    return _uuidJs2['default'].create().hex.toUpperCase();
  };
  var contentUuid = getUUID();
  return {
    PayloadContent: [{
      PayloadCertificateFileName: commonName + '.cer',
      PayloadContent: certBuffer,
      PayloadDescription: 'Adds a CA root certificate',
      PayloadDisplayName: commonName,
      PayloadIdentifier: 'com.apple.security.root.' + contentUuid,
      PayloadType: 'com.apple.security.root',
      PayloadUUID: contentUuid,
      PayloadVersion: 1
    }],
    PayloadDisplayName: commonName,
    PayloadIdentifier: _os2['default'].hostname().split('.')[0] + '.' + getUUID(),
    PayloadRemovalDisallowed: false,
    PayloadType: 'Configuration',
    PayloadUUID: getUUID(),
    PayloadVersion: 1
  };
}

function clickElement(driver, locator) {
  var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

  var element, _options$timeout, timeout, _options$skipIfInvisible, skipIfInvisible, lookupDelay;

  return _regeneratorRuntime.async(function clickElement$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        element = null;
        _options$timeout = options.timeout;
        timeout = _options$timeout === undefined ? 5000 : _options$timeout;
        _options$skipIfInvisible = options.skipIfInvisible;
        skipIfInvisible = _options$skipIfInvisible === undefined ? false : _options$skipIfInvisible;
        lookupDelay = 500;
        context$1$0.prev = 6;
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(timeout < lookupDelay ? 1 : timeout / lookupDelay, lookupDelay, driver.findNativeElementOrElements(locator.type, locator.value, false)));

      case 9:
        element = context$1$0.sent;
        context$1$0.next = 17;
        break;

      case 12:
        context$1$0.prev = 12;
        context$1$0.t0 = context$1$0['catch'](6);

        if (!skipIfInvisible) {
          context$1$0.next = 16;
          break;
        }

        return context$1$0.abrupt('return', false);

      case 16:
        throw new Error('Cannot find ' + JSON.stringify(locator) + ' within ' + timeout + 'ms timeout');

      case 17:
        context$1$0.next = 19;
        return _regeneratorRuntime.awrap(driver.nativeClick(element));

      case 19:
        return context$1$0.abrupt('return', true);

      case 20:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[6, 12]]);
}

function installCertificateInPreferences(driver) {
  return _regeneratorRuntime.async(function installCertificateInPreferences$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Allow',
          // certificate load might take some time on slow machines
          options: { timeout: 15000 }
        }));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(2000));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Install'
        }));

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_bluebird2['default'].delay(1500));

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Install'
        }));

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: '-ios class chain',
          value: '**/XCUIElementTypeSheet/**/XCUIElementTypeButton[`label == \'Install\'`]'
        }));

      case 12:
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Done'
        }));

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function trustCertificateInPreferences(driver, name) {
  var switchLocator;
  return _regeneratorRuntime.async(function trustCertificateInPreferences$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'Return to Settings'
        }));

      case 2:
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'General'
        }));

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: 'accessibility id',
          value: 'About'
        }));

      case 6:
        switchLocator = {
          type: '-ios class chain',
          value: '**/XCUIElementTypeCell[`label == \'' + name + '\'`]/**/XCUIElementTypeSwitch'
        };
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(5, function callee$1$0() {
          return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                context$2$0.t0 = _regeneratorRuntime;
                context$2$0.t1 = driver;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(driver.findNativeElementOrElements('class name', 'XCUIElementTypeTable', false));

              case 4:
                context$2$0.t2 = context$2$0.sent;
                context$2$0.t3 = {
                  element: context$2$0.t2,
                  direction: 'up'
                };
                context$2$0.t4 = context$2$0.t1.mobileSwipe.call(context$2$0.t1, context$2$0.t3);
                context$2$0.next = 9;
                return context$2$0.t0.awrap.call(context$2$0.t0, context$2$0.t4);

              case 9:
                context$2$0.next = 11;
                return _regeneratorRuntime.awrap(clickElement(driver, {
                  type: 'accessibility id',
                  value: 'Certificate Trust Settings',
                  options: { timeout: 500 }
                }));

              case 11:
                context$2$0.next = 13;
                return _regeneratorRuntime.awrap(driver.findNativeElementOrElements(switchLocator.type, switchLocator.value, false));

              case 13:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this);
        }));

      case 9:
        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(clickElement(driver, {
          type: switchLocator.type,
          value: switchLocator.value + '[`value == \'0\'`]',
          options: {
            timeout: 1000,
            skipIfInvisible: true
          }
        }));

      case 11:
        if (!context$1$0.sent) {
          context$1$0.next = 14;
          break;
        }

        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(driver.postAcceptAlert());

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

/**
 * @typedef {Object} CertificateInstallationOptions
 *
 * @property {!string} content - Base64-encoded content of the public certificate
 * @property {?string} commonName - Common name of the certificate. If this is not set
 *                                  then the script will try to parse it from the given
 *                                  certificate content.
 */

/**
 * Installs a custom certificate onto the device.
 * Since Apple provides no official way to do it via command line,
 * this method tries to wrap the certificate into .mobileconfig format
 * and then deploys the wrapped file to the internal HTTP server,
 * so one can open it with mobile Safari.
 * Then the algorithm goes through the profile installation procedure by
 * clicking the necessary buttons using WebDriverAgent.
 *
 * @param {CertificateInstallationOptions} opts
 * @returns {string} The content of the generated .mobileconfig file as
 * base64-encoded string. This config might be useful for debugging purposes.
 */
commands.mobileInstallCertificate = function callee$0$0() {
  var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

  var content, commonName, configName, configPath, certBuffer, cn, mobileConfig, _server$address, address, port, certUrl;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        content = opts.content;
        commonName = opts.commonName;

        if (!_lodash2['default'].isEmpty(content)) {
          context$1$0.next = 4;
          break;
        }

        throw new Error('Certificate content should not be empty');

      case 4:
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(_appiumBaseDriver.STATIC_DIR));

      case 6:
        if (context$1$0.sent) {
          context$1$0.next = 8;
          break;
        }

        throw new Error('The static content root \'' + _appiumBaseDriver.STATIC_DIR + '\' ' + 'does not exist or is not accessible');

      case 8:
        configName = (Math.random() * 0x100000000 + 1).toString(36) + '.' + CONFIG_EXTENSION;
        configPath = _path2['default'].resolve(_appiumBaseDriver.STATIC_DIR, configName);
        certBuffer = Buffer.from(content, 'base64');
        context$1$0.t0 = commonName;

        if (context$1$0.t0) {
          context$1$0.next = 16;
          break;
        }

        context$1$0.next = 15;
        return _regeneratorRuntime.awrap(extractCommonName(certBuffer));

      case 15:
        context$1$0.t0 = context$1$0.sent;

      case 16:
        cn = context$1$0.t0;
        mobileConfig = toMobileConfig(certBuffer, cn);
        context$1$0.prev = 18;
        context$1$0.next = 21;
        return _regeneratorRuntime.awrap(_appiumSupport.plist.updatePlistFile(configPath, mobileConfig, false, false));

      case 21:
        context$1$0.next = 26;
        break;

      case 23:
        context$1$0.prev = 23;
        context$1$0.t1 = context$1$0['catch'](18);
        throw new Error('Cannot store the generated config as \'' + configPath + '\'. ' + ('Original error: ' + context$1$0.t1.message));

      case 26:
        context$1$0.prev = 26;
        _server$address = this.server.address();
        address = _server$address.address;
        port = _server$address.port;
        certUrl = 'http://' + (address ? address : _os2['default'].hostname()) + ':' + (port ? port : 4723) + '/' + configName;
        context$1$0.prev = 31;

        if (!this.isRealDevice()) {
          context$1$0.next = 48;
          break;
        }

        context$1$0.prev = 33;
        context$1$0.next = 36;
        return _regeneratorRuntime.awrap(this.proxyCommand('/url', 'POST', { url: certUrl }));

      case 36:
        context$1$0.next = 46;
        break;

      case 38:
        context$1$0.prev = 38;
        context$1$0.t2 = context$1$0['catch'](33);

        if (!this.isWebContext()) {
          context$1$0.next = 45;
          break;
        }

        context$1$0.next = 43;
        return _regeneratorRuntime.awrap(_appiumIosDriver.iosCommands.general.setUrl.call(this, certUrl));

      case 43:
        context$1$0.next = 46;
        break;

      case 45:
        throw context$1$0.t2;

      case 46:
        context$1$0.next = 50;
        break;

      case 48:
        context$1$0.next = 50;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, certUrl));

      case 50:
        context$1$0.next = 52;
        return _regeneratorRuntime.awrap(installCertificateInPreferences(this));

      case 52:
        context$1$0.next = 54;
        return _regeneratorRuntime.awrap(trustCertificateInPreferences(this, cn));

      case 54:
        context$1$0.prev = 54;
        context$1$0.prev = 55;
        context$1$0.next = 58;
        return _regeneratorRuntime.awrap(this.activateApp(this.opts.bundleId));

      case 58:
        context$1$0.next = 63;
        break;

      case 60:
        context$1$0.prev = 60;
        context$1$0.t3 = context$1$0['catch'](55);

        _logger2['default'].warn('Cannot restore the application \'' + this.opts.bundleId + '\'. Original error: ' + context$1$0.t3.message);

      case 63:
        return context$1$0.finish(54);

      case 64:
        context$1$0.next = 66;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.readFile(configPath));

      case 66:
        return context$1$0.abrupt('return', context$1$0.sent.toString('base64'));

      case 67:
        context$1$0.prev = 67;
        context$1$0.next = 70;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(configPath));

      case 70:
        return context$1$0.finish(67);

      case 71:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[18, 23], [26,, 67, 71], [31,, 54, 64], [33, 38], [55, 60]]);
};

_Object$assign(extensions, commands);
exports.commands = commands;
exports['default'] = extensions;

// Accept Safari alert

// Wait until Preferences are opened

// Go through Preferences wizard

// We need to click Install button on two different tabs
// The second one confirms the previous

// Accept sheet alert

// Finish adding certificate

// Only click the switch if it is set to Off

// The command above does not always work on real devices
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7c0JBQWMsUUFBUTs7Ozs2QkFDYSxnQkFBZ0I7OytCQUN2QixtQkFBbUI7O2dDQUNwQixvQkFBb0I7OzBCQUN2QixhQUFhOzt3QkFDQSxVQUFVOzt3QkFDakMsVUFBVTs7OztzQkFDUixXQUFXOzs7O2tCQUNaLElBQUk7Ozs7b0JBQ0YsTUFBTTs7OztzQkFDTixTQUFTOzs7OzRCQUNMLGNBQWM7O0FBRW5DLElBQUksVUFBVSxHQUFHLEVBQUU7SUFBRSxRQUFRLEdBQUcsRUFBRSxDQUFDOztBQUVuQyxJQUFNLGdCQUFnQixHQUFHLGNBQWMsQ0FBQzs7QUFHeEMsU0FBZSxpQkFBaUIsQ0FBRSxVQUFVO01BQ3BDLFFBQVEsUUFNTCxNQUFNLEVBQ1AsT0FBTzs7Ozs7O3lDQVBRLHVCQUFRLElBQUksQ0FBQztBQUNsQyxnQkFBTSxFQUFFLE1BQU07QUFDZCxnQkFBTSxFQUFFLE1BQU07U0FDZixDQUFDOzs7QUFISSxnQkFBUTs7O3lDQUtOLGtCQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLFVBQVUsQ0FBQzs7Ozt5Q0FDdEIsd0JBQUssU0FBUyxFQUFFLENBQUMsTUFBTSxFQUFFLFFBQVEsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFFLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUFyRixjQUFNLFFBQU4sTUFBTTtBQUNQLGVBQU8sR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDOzthQUN6QyxPQUFPOzs7Ozs0Q0FDRixPQUFPLENBQUMsQ0FBQyxDQUFDOzs7Y0FFYixJQUFJLEtBQUsseUNBQXNDLE1BQU0sZUFBVzs7Ozs7Y0FFaEUsSUFBSSxLQUFLLENBQUMsZ0hBQ21CLGVBQUksT0FBTyxDQUFFLENBQUM7Ozs7O3lDQUUzQyxrQkFBRyxNQUFNLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQzs7Ozs7Ozs7OztD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bGUiOiJsaWIvY29tbWFuZHMvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZnMsIHBsaXN0LCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgaW9zQ29tbWFuZHMgfSBmcm9tICdhcHBpdW0taW9zLWRyaXZlcic7XG5pbXBvcnQgeyBTVEFUSUNfRElSIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IG9wZW5VcmwgfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyByZXRyeUludGVydmFsLCByZXRyeSB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBVVUlEIGZyb20gJ3V1aWQtanMnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5cbmxldCBleHRlbnNpb25zID0ge30sIGNvbW1hbmRzID0ge307XG5cbmNvbnN0IENPTkZJR19FWFRFTlNJT04gPSAnbW9iaWxlY29uZmlnJztcblxuXG5hc3luYyBmdW5jdGlvbiBleHRyYWN0Q29tbW9uTmFtZSAoY2VydEJ1ZmZlcikge1xuICBjb25zdCB0ZW1wQ2VydCA9IGF3YWl0IHRlbXBEaXIub3Blbih7XG4gICAgcHJlZml4OiAnY2VydCcsXG4gICAgc3VmZml4OiAnLmNlcidcbiAgfSk7XG4gIHRyeSB7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBDZXJ0LnBhdGgsIGNlcnRCdWZmZXIpO1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYygnb3BlbnNzbCcsIFsneDUwOScsICctbm9vdXQnLCAnLXN1YmplY3QnLCAnLWluJywgdGVtcENlcnQucGF0aF0pO1xuICAgIGNvbnN0IGNuTWF0Y2ggPSAvXFwvQ049KFteXFxzLF0rKS8uZXhlYyhzdGRvdXQpO1xuICAgIGlmIChjbk1hdGNoKSB7XG4gICAgICByZXR1cm4gY25NYXRjaFsxXTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBjb21tb24gbmFtZSB2YWx1ZSBpbiAnJHtzdGRvdXR9JyBvdXRwdXRgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgY29tbW9uIG5hbWUgdmFsdWUgZnJvbSB0aGUgY2VydGlmaWNhdGUuIElzIGl0IHZhbGlkIGFuZCBiYXNlNjQtZW5jb2RlZD8gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodGVtcENlcnQucGF0aCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZXMgQXBwbGUncyBvdmVyLXRoZS1haXIgY29uZmlndXJhdGlvbiBwcm9maWxlXG4gKiBmb3IgY2VydGlmaWNhdGUgZGVwbG95bWVudCBiYXNlZCBvbiB0aGUgZ2l2ZW4gUEVNIGNlcnRpZmljYXRlIGNvbnRlbnQuXG4gKiBSZWFkIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9saWJyYXJ5L2NvbnRlbnQvZG9jdW1lbnRhdGlvbi9OZXR3b3JraW5nSW50ZXJuZXQvQ29uY2VwdHVhbC9pUGhvbmVPVEFDb25maWd1cmF0aW9uL0ludHJvZHVjdGlvbi9JbnRyb2R1Y3Rpb24uaHRtbFxuICogZm9yIG1vcmUgZGV0YWlscyBvbiBzdWNoIHByb2ZpbGVzLlxuICpcbiAqIEBwYXJhbSB7QnVmZmVyfSBjZXJ0QnVmZmVyIC0gVGhlIGFjdHVhbCBjb250ZW50IG9mIFBFTSBjZXJ0aWZpY2F0ZSBlbmNvZGVkIGludG8gTm9kZUpTIGJ1ZmZlclxuICogQHBhcmFtIHtzdHJpbmd9IGNvbW1vbk5hbWUgLSBDZXJ0aWZpY2F0ZSdzIGNvbW1vbiBuYW1lXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgZW5jb2RlZCBzdHJ1Y3R1cmUgb2YgdGhlIGdpdmVuIGNlcnRpZmljYXRlLCB3aGljaCBpcyByZWFkeSB0byBiZSBwYXNzZWRcbiAqIGFzIGFuIGFyZ3VtZW50IHRvIHBsaXN0IGJ1aWxkZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgZ2l2ZW4gY2VydGlmaWNhdGUgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiB0b01vYmlsZUNvbmZpZyAoY2VydEJ1ZmZlciwgY29tbW9uTmFtZSkge1xuICBjb25zdCBnZXRVVUlEID0gKCkgPT4gVVVJRC5jcmVhdGUoKS5oZXgudG9VcHBlckNhc2UoKTtcbiAgY29uc3QgY29udGVudFV1aWQgPSBnZXRVVUlEKCk7XG4gIHJldHVybiB7XG4gICAgUGF5bG9hZENvbnRlbnQ6IFt7XG4gICAgICBQYXlsb2FkQ2VydGlmaWNhdGVGaWxlTmFtZTogYCR7Y29tbW9uTmFtZX0uY2VyYCxcbiAgICAgIFBheWxvYWRDb250ZW50OiBjZXJ0QnVmZmVyLFxuICAgICAgUGF5bG9hZERlc2NyaXB0aW9uOiAnQWRkcyBhIENBIHJvb3QgY2VydGlmaWNhdGUnLFxuICAgICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgICAgUGF5bG9hZElkZW50aWZpZXI6IGBjb20uYXBwbGUuc2VjdXJpdHkucm9vdC4ke2NvbnRlbnRVdWlkfWAsXG4gICAgICBQYXlsb2FkVHlwZTogJ2NvbS5hcHBsZS5zZWN1cml0eS5yb290JyxcbiAgICAgIFBheWxvYWRVVUlEOiBjb250ZW50VXVpZCxcbiAgICAgIFBheWxvYWRWZXJzaW9uOiAxXG4gICAgfV0sXG4gICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgIFBheWxvYWRJZGVudGlmaWVyOiBgJHtvcy5ob3N0bmFtZSgpLnNwbGl0KCcuJylbMF19LiR7Z2V0VVVJRCgpfWAsXG4gICAgUGF5bG9hZFJlbW92YWxEaXNhbGxvd2VkOiBmYWxzZSxcbiAgICBQYXlsb2FkVHlwZTogJ0NvbmZpZ3VyYXRpb24nLFxuICAgIFBheWxvYWRVVUlEOiBnZXRVVUlEKCksXG4gICAgUGF5bG9hZFZlcnNpb246IDFcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xpY2tFbGVtZW50IChkcml2ZXIsIGxvY2F0b3IsIG9wdGlvbnMgPSB7fSkge1xuICBsZXQgZWxlbWVudCA9IG51bGw7XG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gNTAwMCxcbiAgICBza2lwSWZJbnZpc2libGUgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbG9va3VwRGVsYXkgPSA1MDA7XG4gIHRyeSB7XG4gICAgZWxlbWVudCA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwodGltZW91dCA8IGxvb2t1cERlbGF5ID8gMSA6IHRpbWVvdXQgLyBsb29rdXBEZWxheSwgbG9va3VwRGVsYXksXG4gICAgICBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKGxvY2F0b3IudHlwZSwgbG9jYXRvci52YWx1ZSwgZmFsc2UpXG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHNraXBJZkludmlzaWJsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kICR7SlNPTi5zdHJpbmdpZnkobG9jYXRvcil9IHdpdGhpbiAke3RpbWVvdXR9bXMgdGltZW91dGApO1xuICB9XG4gIGF3YWl0IGRyaXZlci5uYXRpdmVDbGljayhlbGVtZW50KTtcbiAgcmV0dXJuIHRydWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXMgKGRyaXZlcikge1xuICAvLyBBY2NlcHQgU2FmYXJpIGFsZXJ0XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdBbGxvdycsXG4gICAgLy8gY2VydGlmaWNhdGUgbG9hZCBtaWdodCB0YWtlIHNvbWUgdGltZSBvbiBzbG93IG1hY2hpbmVzXG4gICAgb3B0aW9uczogeyB0aW1lb3V0OiAxNTAwMCB9LFxuICB9KTtcbiAgLy8gV2FpdCB1bnRpbCBQcmVmZXJlbmNlcyBhcmUgb3BlbmVkXG4gIGF3YWl0IEIuZGVsYXkoMjAwMCk7XG5cbiAgLy8gR28gdGhyb3VnaCBQcmVmZXJlbmNlcyB3aXphcmRcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0luc3RhbGwnXG4gIH0pO1xuICAvLyBXZSBuZWVkIHRvIGNsaWNrIEluc3RhbGwgYnV0dG9uIG9uIHR3byBkaWZmZXJlbnQgdGFic1xuICAvLyBUaGUgc2Vjb25kIG9uZSBjb25maXJtcyB0aGUgcHJldmlvdXNcbiAgYXdhaXQgQi5kZWxheSgxNTAwKTtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0luc3RhbGwnXG4gIH0pO1xuICAvLyBBY2NlcHQgc2hlZXQgYWxlcnRcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICctaW9zIGNsYXNzIGNoYWluJyxcbiAgICB2YWx1ZTogJyoqL1hDVUlFbGVtZW50VHlwZVNoZWV0LyoqL1hDVUlFbGVtZW50VHlwZUJ1dHRvbltgbGFiZWwgPT0gXFwnSW5zdGFsbFxcJ2BdJ1xuICB9KTtcbiAgLy8gRmluaXNoIGFkZGluZyBjZXJ0aWZpY2F0ZVxuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnRG9uZSdcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRydXN0Q2VydGlmaWNhdGVJblByZWZlcmVuY2VzIChkcml2ZXIsIG5hbWUpIHtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ1JldHVybiB0byBTZXR0aW5ncydcbiAgfSk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdHZW5lcmFsJ1xuICB9KTtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0Fib3V0J1xuICB9KTtcbiAgY29uc3Qgc3dpdGNoTG9jYXRvciA9IHtcbiAgICB0eXBlOiAnLWlvcyBjbGFzcyBjaGFpbicsXG4gICAgdmFsdWU6IGAqKi9YQ1VJRWxlbWVudFR5cGVDZWxsW1xcYGxhYmVsID09ICcke25hbWV9J1xcYF0vKiovWENVSUVsZW1lbnRUeXBlU3dpdGNoYCxcbiAgfTtcbiAgYXdhaXQgcmV0cnkoNSwgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGRyaXZlci5tb2JpbGVTd2lwZSh7XG4gICAgICBlbGVtZW50OiBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZVRhYmxlJywgZmFsc2UpLFxuICAgICAgZGlyZWN0aW9uOiAndXAnXG4gICAgfSk7XG4gICAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgICAgdmFsdWU6ICdDZXJ0aWZpY2F0ZSBUcnVzdCBTZXR0aW5ncycsXG4gICAgICBvcHRpb25zOiB7IHRpbWVvdXQ6IDUwMCB9LFxuICAgIH0pO1xuXG4gICAgYXdhaXQgZHJpdmVyLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyhzd2l0Y2hMb2NhdG9yLnR5cGUsIHN3aXRjaExvY2F0b3IudmFsdWUsIGZhbHNlKTtcbiAgfSk7XG4gIC8vIE9ubHkgY2xpY2sgdGhlIHN3aXRjaCBpZiBpdCBpcyBzZXQgdG8gT2ZmXG4gIGlmIChhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogc3dpdGNoTG9jYXRvci50eXBlLFxuICAgIHZhbHVlOiBgJHtzd2l0Y2hMb2NhdG9yLnZhbHVlfVtcXGB2YWx1ZSA9PSAnMCdcXGBdYCxcbiAgICBvcHRpb25zOiB7XG4gICAgICB0aW1lb3V0OiAxMDAwLFxuICAgICAgc2tpcElmSW52aXNpYmxlOiB0cnVlXG4gICAgfVxuICB9KSkge1xuICAgIGF3YWl0IGRyaXZlci5wb3N0QWNjZXB0QWxlcnQoKTtcbiAgfVxufVxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IENlcnRpZmljYXRlSW5zdGFsbGF0aW9uT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7IXN0cmluZ30gY29udGVudCAtIEJhc2U2NC1lbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHB1YmxpYyBjZXJ0aWZpY2F0ZVxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBjb21tb25OYW1lIC0gQ29tbW9uIG5hbWUgb2YgdGhlIGNlcnRpZmljYXRlLiBJZiB0aGlzIGlzIG5vdCBzZXRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZW4gdGhlIHNjcmlwdCB3aWxsIHRyeSB0byBwYXJzZSBpdCBmcm9tIHRoZSBnaXZlblxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VydGlmaWNhdGUgY29udGVudC5cbiAqL1xuXG4vKipcbiAqIEluc3RhbGxzIGEgY3VzdG9tIGNlcnRpZmljYXRlIG9udG8gdGhlIGRldmljZS5cbiAqIFNpbmNlIEFwcGxlIHByb3ZpZGVzIG5vIG9mZmljaWFsIHdheSB0byBkbyBpdCB2aWEgY29tbWFuZCBsaW5lLFxuICogdGhpcyBtZXRob2QgdHJpZXMgdG8gd3JhcCB0aGUgY2VydGlmaWNhdGUgaW50byAubW9iaWxlY29uZmlnIGZvcm1hdFxuICogYW5kIHRoZW4gZGVwbG95cyB0aGUgd3JhcHBlZCBmaWxlIHRvIHRoZSBpbnRlcm5hbCBIVFRQIHNlcnZlcixcbiAqIHNvIG9uZSBjYW4gb3BlbiBpdCB3aXRoIG1vYmlsZSBTYWZhcmkuXG4gKiBUaGVuIHRoZSBhbGdvcml0aG0gZ29lcyB0aHJvdWdoIHRoZSBwcm9maWxlIGluc3RhbGxhdGlvbiBwcm9jZWR1cmUgYnlcbiAqIGNsaWNraW5nIHRoZSBuZWNlc3NhcnkgYnV0dG9ucyB1c2luZyBXZWJEcml2ZXJBZ2VudC5cbiAqXG4gKiBAcGFyYW0ge0NlcnRpZmljYXRlSW5zdGFsbGF0aW9uT3B0aW9uc30gb3B0c1xuICogQHJldHVybnMge3N0cmluZ30gVGhlIGNvbnRlbnQgb2YgdGhlIGdlbmVyYXRlZCAubW9iaWxlY29uZmlnIGZpbGUgYXNcbiAqIGJhc2U2NC1lbmNvZGVkIHN0cmluZy4gVGhpcyBjb25maWcgbWlnaHQgYmUgdXNlZnVsIGZvciBkZWJ1Z2dpbmcgcHVycG9zZXMuXG4gKi9cbmNvbW1hbmRzLm1vYmlsZUluc3RhbGxDZXJ0aWZpY2F0ZSA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgY29uc3Qge2NvbnRlbnQsIGNvbW1vbk5hbWV9ID0gb3B0cztcbiAgaWYgKF8uaXNFbXB0eShjb250ZW50KSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2VydGlmaWNhdGUgY29udGVudCBzaG91bGQgbm90IGJlIGVtcHR5Jyk7XG4gIH1cblxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhTVEFUSUNfRElSKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHN0YXRpYyBjb250ZW50IHJvb3QgJyR7U1RBVElDX0RJUn0nIGAgK1xuICAgICAgICAgICAgICAgICAgICBgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuICBjb25zdCBjb25maWdOYW1lID0gYCR7KE1hdGgucmFuZG9tKCkgKiAweDEwMDAwMDAwMCArIDEpLnRvU3RyaW5nKDM2KX0uJHtDT05GSUdfRVhURU5TSU9OfWA7XG4gIGNvbnN0IGNvbmZpZ1BhdGggPSBwYXRoLnJlc29sdmUoU1RBVElDX0RJUiwgY29uZmlnTmFtZSk7XG4gIGNvbnN0IGNlcnRCdWZmZXIgPSBCdWZmZXIuZnJvbShjb250ZW50LCAnYmFzZTY0Jyk7XG4gIGNvbnN0IGNuID0gY29tbW9uTmFtZSB8fCBhd2FpdCBleHRyYWN0Q29tbW9uTmFtZShjZXJ0QnVmZmVyKTtcbiAgY29uc3QgbW9iaWxlQ29uZmlnID0gdG9Nb2JpbGVDb25maWcoY2VydEJ1ZmZlciwgY24pO1xuICB0cnkge1xuICAgIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZShjb25maWdQYXRoLCBtb2JpbGVDb25maWcsIGZhbHNlLCBmYWxzZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IHN0b3JlIHRoZSBnZW5lcmF0ZWQgY29uZmlnIGFzICcke2NvbmZpZ1BhdGh9Jy4gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICB0cnkge1xuICAgIGNvbnN0IHthZGRyZXNzLCBwb3J0fSA9IHRoaXMuc2VydmVyLmFkZHJlc3MoKTtcbiAgICBjb25zdCBjZXJ0VXJsID0gYGh0dHA6Ly8ke2FkZHJlc3MgPyBhZGRyZXNzIDogb3MuaG9zdG5hbWUoKX06JHtwb3J0ID8gcG9ydCA6IDQ3MjN9LyR7Y29uZmlnTmFtZX1gO1xuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvdXJsJywgJ1BPU1QnLCB7dXJsOiBjZXJ0VXJsfSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgICAgICAgICAvLyBUaGUgY29tbWFuZCBhYm92ZSBkb2VzIG5vdCBhbHdheXMgd29yayBvbiByZWFsIGRldmljZXNcbiAgICAgICAgICAgIGF3YWl0IGlvc0NvbW1hbmRzLmdlbmVyYWwuc2V0VXJsLmNhbGwodGhpcywgY2VydFVybCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGF3YWl0IG9wZW5VcmwodGhpcy5vcHRzLnVkaWQgfHwgdGhpcy5zaW0udWRpZCwgY2VydFVybCk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXModGhpcyk7XG4gICAgICBhd2FpdCB0cnVzdENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyh0aGlzLCBjbik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYWN0aXZhdGVBcHAodGhpcy5vcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYENhbm5vdCByZXN0b3JlIHRoZSBhcHBsaWNhdGlvbiAnJHt0aGlzLm9wdHMuYnVuZGxlSWR9Jy4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiAoYXdhaXQgZnMucmVhZEZpbGUoY29uZmlnUGF0aCkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoY29uZmlnUGF0aCk7XG4gIH1cbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMpO1xuZXhwb3J0IHsgY29tbWFuZHMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
