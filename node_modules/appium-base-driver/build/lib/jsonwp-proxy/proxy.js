'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _extends = require('babel-runtime/helpers/extends')['default'];

var _defineProperty = require('babel-runtime/helpers/define-property')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumSupport = require('appium-support');

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _jsonwpStatusStatus = require('../jsonwp-status/status');

var _protocolErrors = require('../protocol/errors');

var _basedriverDriver = require('../basedriver/driver');

var _basedriverDriver2 = _interopRequireDefault(_basedriverDriver);

var _protocolRoutes = require('../protocol/routes');

var log = _appiumSupport.logger.getLogger('JSONWP Proxy');
// TODO: Make this value configurable as a server side capability
var LOG_OBJ_LENGTH = 1024; // MAX LENGTH Logged to file / console
var DEFAULT_REQUEST_TIMEOUT = 240000;

var COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync');
  }
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: function jsonwpConverter(url) {
    return url.replace(/\/element\/([^\/]+)\/screenshot$/, '/screenshot/$1');
  },
  w3cConverter: function w3cConverter(url) {
    return url.replace(/\/screenshot\/([^\/]+)/, '/element/$1/screenshot');
  }
}];

var _BaseDriver$DRIVER_PROTOCOL = _basedriverDriver2['default'].DRIVER_PROTOCOL;
var MJSONWP = _BaseDriver$DRIVER_PROTOCOL.MJSONWP;
var W3C = _BaseDriver$DRIVER_PROTOCOL.W3C;

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
  }

  // abstract the call behind a member function
  // so that we can mock it in tests

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      var currentRequest,
          args$2$0 = arguments;
      return _regeneratorRuntime.async(function request$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            currentRequest = _requestPromise2['default'].apply(undefined, args$2$0);

            this._activeRequests.push(currentRequest);
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(currentRequest['finally'](function () {
              return _lodash2['default'].pull(_this._activeRequests, currentRequest);
            }));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getActiveRequestsCount',
    value: function getActiveRequestsCount() {
      return this._activeRequests.length;
    }
  }, {
    key: 'cancelActiveRequests',
    value: function cancelActiveRequests() {
      try {
        var _iteratorNormalCompletion = true;
        var _didIteratorError = false;
        var _iteratorError = undefined;

        try {
          for (var _iterator = _getIterator(this._activeRequests), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
            var r = _step.value;

            r.cancel();
          }
        } catch (err) {
          _didIteratorError = true;
          _iteratorError = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion && _iterator['return']) {
              _iterator['return']();
            }
          } finally {
            if (_didIteratorError) {
              throw _iteratorError;
            }
          }
        }
      } finally {
        this._activeRequests = [];
      }
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_lodash2['default'].includes(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') {
        url = '/';
      }
      var proxyBase = this.scheme + '://' + this.server + ':' + this.port + this.base;
      var endpointRe = '(/(session|status))';
      var remainingUrl = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        remainingUrl = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        remainingUrl = url;
      } else {
        throw new Error('Did not know what to do with url \'' + url + '\'');
      }

      var stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');
      if (stripPrefixRe.test(remainingUrl)) {
        remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
      }

      if (!new RegExp(endpointRe).test(remainingUrl)) {
        remainingUrl = '/session/' + this.sessionId + remainingUrl;
      }

      var requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(remainingUrl)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(remainingUrl);
        remainingUrl = remainingUrl.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Could not find :session section for url: ' + remainingUrl);
      }
      remainingUrl = remainingUrl.replace(/\/$/, ''); // can't have trailing slashes

      return proxyBase + remainingUrl;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];
      var newUrl, reqOpts, res, resBody, resBodyObj, message, err, responseError;
      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: newUrl,
              method: method,
              headers: {
                'content-type': 'application/json; charset=utf-8',
                'user-agent': 'appium',
                accept: '*/*'
              },
              resolveWithFullResponse: true,
              timeout: this.timeout,
              forever: true
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }

            // GET methods shouldn't have any body. Most servers are OK with this, but WebDriverAgent throws 400 errors
            if (method === 'GET') {
              reqOpts.json = null;
            }

            log.debug('Proxying [' + method + ' ' + (url || "/") + '] to [' + method + ' ' + newUrl + '] ' + (body ? 'with body: ' + _lodash2['default'].truncate(JSON.stringify(body), { length: LOG_OBJ_LENGTH }) : 'with no body'));

            res = undefined, resBody = undefined;
            context$2$0.prev = 7;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.request(reqOpts));

          case 10:
            res = context$2$0.sent;

            resBody = res.body;
            log.debug('Got response with status ' + res.statusCode + ': ' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: LOG_OBJ_LENGTH }));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

            if (!this._downstreamProtocol) {
              this._downstreamProtocol = this.getProtocolFromResBody(resBodyObj);
            }

            if (!(res.statusCode < 400 && this._downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0)) {
              context$2$0.next = 23;
              break;
            }

            message = 'The request to ' + url + ' has failed';
            err = new Error(message);

            err.message = message;
            err.error = resBody;
            err.statusCode = 500;
            throw err;

          case 23:
            context$2$0.next = 30;
            break;

          case 25:
            context$2$0.prev = 25;
            context$2$0.t0 = context$2$0['catch'](7);
            responseError = undefined;

            try {
              responseError = JSON.parse(context$2$0.t0.error);
            } catch (e1) {
              if (!_lodash2['default'].isEmpty(context$2$0.t0.error) && _lodash2['default'].isString(context$2$0.t0.error)) {
                log.warn('Got an unexpected response: ' + _lodash2['default'].truncate(context$2$0.t0.error, { length: 300 }));
              }
              responseError = _lodash2['default'].isPlainObject(context$2$0.t0.error) ? context$2$0.t0.error : null;
            }
            throw new _protocolErrors.errors.ProxyRequestError('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message), responseError, context$2$0.t0.statusCode);

          case 30:
            return context$2$0.abrupt('return', [res, resBody]);

          case 31:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[7, 25]]);
    }

    /**
     * W3C /timeouts can take as many as 3 timeout types at once, MJSONWP /timeouts only takes one
     * at a time. So if we're using W3C and proxying to MJSONWP and there's more than one timeout type
     * provided in the request, we need to do 3 proxies and combine the result
     *
     * @param {Object} body Request body
     * @return {Array} Array of W3C + MJSONWP compatible timeout objects
     */
  }, {
    key: 'getTimeoutRequestObjects',
    value: function getTimeoutRequestObjects(body) {
      var _extends2;

      var protocol = body.protocol;

      var timeoutObjects = [];
      var baseObj = {
        script: body.script,
        pageLoad: body.pageLoad,
        implicit: body.implicit
      };
      if (protocol === W3C) {
        var _iteratorNormalCompletion2 = true;
        var _didIteratorError2 = false;
        var _iteratorError2 = undefined;

        try {
          for (var _iterator2 = _getIterator(_lodash2['default'].toPairs(baseObj)), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
            var _step2$value = _slicedToArray(_step2.value, 2);

            var type = _step2$value[0];
            var ms = _step2$value[1];

            if (_lodash2['default'].isNumber(ms)) {
              timeoutObjects.push(_extends({}, baseObj, {
                type: type,
                ms: ms
              }));
            }
          }
        } catch (err) {
          _didIteratorError2 = true;
          _iteratorError2 = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion2 && _iterator2['return']) {
              _iterator2['return']();
            }
          } finally {
            if (_didIteratorError2) {
              throw _iteratorError2;
            }
          }
        }

        return timeoutObjects;
      }

      return [_extends({}, baseObj, (_extends2 = {}, _defineProperty(_extends2, body.type, body.ms), _defineProperty(_extends2, 'type', body.type), _defineProperty(_extends2, 'ms', body.ms), _extends2))];
    }

    /**
     * Proxy an array of timeout objects and merge the result
     * @param {String} url Endpoint url
     * @param {String} method Endpoint method
     * @param {Object} body Request body
     */
  }, {
    key: 'proxySetTimeouts',
    value: function proxySetTimeouts(url, method, body) {
      var response, resBody, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, timeoutObj, _ref, _ref2, protocol;

      return _regeneratorRuntime.async(function proxySetTimeouts$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined, resBody = undefined;
            _iteratorNormalCompletion3 = true;
            _didIteratorError3 = false;
            _iteratorError3 = undefined;
            context$2$0.prev = 4;
            _iterator3 = _getIterator(this.getTimeoutRequestObjects(body));

          case 6:
            if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
              context$2$0.next = 22;
              break;
            }

            timeoutObj = _step3.value;
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.proxy(url, method, timeoutObj));

          case 10:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 2);
            response = _ref2[0];
            resBody = _ref2[1];
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol !== MJSONWP)) {
              context$2$0.next = 17;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 17:
            if (!(response.statusCode >= 400)) {
              context$2$0.next = 19;
              break;
            }

            return context$2$0.abrupt('return', [response, resBody]);

          case 19:
            _iteratorNormalCompletion3 = true;
            context$2$0.next = 6;
            break;

          case 22:
            context$2$0.next = 28;
            break;

          case 24:
            context$2$0.prev = 24;
            context$2$0.t0 = context$2$0['catch'](4);
            _didIteratorError3 = true;
            _iteratorError3 = context$2$0.t0;

          case 28:
            context$2$0.prev = 28;
            context$2$0.prev = 29;

            if (!_iteratorNormalCompletion3 && _iterator3['return']) {
              _iterator3['return']();
            }

          case 31:
            context$2$0.prev = 31;

            if (!_didIteratorError3) {
              context$2$0.next = 34;
              break;
            }

            throw _iteratorError3;

          case 34:
            return context$2$0.finish(31);

          case 35:
            return context$2$0.finish(28);

          case 36:
            return context$2$0.abrupt('return', [response, resBody]);

          case 37:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[4, 24, 28, 36], [29,, 31, 35]]);
    }
  }, {
    key: 'getProtocolFromResBody',
    value: function getProtocolFromResBody(resBody) {
      if (!_lodash2['default'].isPlainObject(resBody)) {
        try {
          resBody = JSON.parse(resBody);
        } catch (err) {
          return;
        }
      }
      if (_appiumSupport.util.hasValue(resBody.status)) {
        return MJSONWP;
      }
      if (_appiumSupport.util.hasValue(resBody.value)) {
        return W3C;
      }
    }
  }, {
    key: 'getDownstreamProtocol',
    value: function getDownstreamProtocol() {
      var _ref3, _ref32, resBody;

      return _regeneratorRuntime.async(function getDownstreamProtocol$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            if (this._downstreamProtocol) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(this.proxy('/status', 'GET'));

          case 3:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            resBody = _ref32[1];

            this._downstreamProtocol = this.getProtocolFromResBody(resBody);

          case 7:
            return context$2$0.abrupt('return', this._downstreamProtocol);

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'requestToCommandName',
    value: function requestToCommandName(url, method) {
      var extractCommandName = function extractCommandName(pattern) {
        var pathMatch = pattern.exec(url);
        return pathMatch ? (0, _protocolRoutes.routeToCommandName)(pathMatch[1], method) : null;
      };
      var commandName = (0, _protocolRoutes.routeToCommandName)(url, method);
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/session/')) {
        commandName = extractCommandName(/\/wd\/hub\/session\/[^\/]+(.+)/);
      }
      if (!commandName && _lodash2['default'].includes(url, '/wd/hub/')) {
        commandName = extractCommandName(/\/wd\/hub(\/.+)/);
      }
      return commandName;
    }
  }, {
    key: 'proxyCommand',
    value: function proxyCommand(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var commandName, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, _step4$value,

      // Same arguments, but different URLs

      commandNames, jsonwpConverter, w3cConverter, downstreamProtocol, rewrittenUrl;

      return _regeneratorRuntime.async(function proxyCommand$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            commandName = this.requestToCommandName(url, method);

            if (commandName) {
              context$2$0.next = 5;
              break;
            }

            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 4:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 5:
            log.debug('Matched \'' + url + '\' to command name \'' + commandName + '\'');

            // Handle "crossing" endpoints for the case
            // when upstream and downstream drivers operate different protocols

            // Same url, but different arguments

            if (!(commandName === 'timeouts')) {
              context$2$0.next = 10;
              break;
            }

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.proxySetTimeouts(url, method, body));

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
            _iteratorNormalCompletion4 = true;
            _didIteratorError4 = false;
            _iteratorError4 = undefined;
            context$2$0.prev = 13;
            _iterator4 = _getIterator(COMMAND_URLS_CONFLICTS);

          case 15:
            if (_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done) {
              context$2$0.next = 46;
              break;
            }

            _step4$value = _step4.value;
            commandNames = _step4$value.commandNames;
            jsonwpConverter = _step4$value.jsonwpConverter;
            w3cConverter = _step4$value.w3cConverter;

            if (commandNames.includes(commandName)) {
              context$2$0.next = 22;
              break;
            }

            return context$2$0.abrupt('continue', 43);

          case 22:
            downstreamProtocol = undefined;
            context$2$0.prev = 23;
            context$2$0.next = 26;
            return _regeneratorRuntime.awrap(this.getDownstreamProtocol());

          case 26:
            downstreamProtocol = context$2$0.sent;
            context$2$0.next = 32;
            break;

          case 29:
            context$2$0.prev = 29;
            context$2$0.t0 = context$2$0['catch'](23);

            log.warn(context$2$0.t0);

          case 32:
            if (downstreamProtocol) {
              context$2$0.next = 35;
              break;
            }

            log.warn('The downstream protocol cannot be detected. Proxying as is');
            return context$2$0.abrupt('break', 46);

          case 35:
            rewrittenUrl = downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

            if (!(rewrittenUrl === url)) {
              context$2$0.next = 39;
              break;
            }

            log.debug('Did not know how to rewrite the original URL \'' + url + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            return context$2$0.abrupt('break', 46);

          case 39:
            log.info('Rewrote the original URL \'' + url + '\' to \'' + rewrittenUrl + '\' ' + ('for ' + downstreamProtocol + ' protocol'));
            context$2$0.next = 42;
            return _regeneratorRuntime.awrap(this.proxy(rewrittenUrl, method, body));

          case 42:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 43:
            _iteratorNormalCompletion4 = true;
            context$2$0.next = 15;
            break;

          case 46:
            context$2$0.next = 52;
            break;

          case 48:
            context$2$0.prev = 48;
            context$2$0.t1 = context$2$0['catch'](13);
            _didIteratorError4 = true;
            _iteratorError4 = context$2$0.t1;

          case 52:
            context$2$0.prev = 52;
            context$2$0.prev = 53;

            if (!_iteratorNormalCompletion4 && _iterator4['return']) {
              _iterator4['return']();
            }

          case 55:
            context$2$0.prev = 55;

            if (!_didIteratorError4) {
              context$2$0.next = 58;
              break;
            }

            throw _iteratorError4;

          case 58:
            return context$2$0.finish(55);

          case 59:
            return context$2$0.finish(52);

          case 60:
            context$2$0.next = 62;
            return _regeneratorRuntime.awrap(this.proxy(url, method, body));

          case 62:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 63:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[13, 48, 52, 60], [23, 29], [53,, 55, 59]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments.length <= 2 || arguments[2] === undefined ? null : arguments[2];

      var response, resBody, _ref4, _ref42, protocol, _status, message;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined;
            resBody = undefined;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand(url, method, body));

          case 5:
            _ref4 = context$2$0.sent;
            _ref42 = _slicedToArray(_ref4, 2);
            response = _ref42[0];
            resBody = _ref42[1];
            context$2$0.next = 16;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](2);

            if (!(0, _protocolErrors.isErrorType)(context$2$0.t0, _protocolErrors.errors.ProxyRequestError)) {
              context$2$0.next = 15;
              break;
            }

            throw context$2$0.t0.getActualError();

          case 15:
            throw new _protocolErrors.errors.UnknownError(context$2$0.t0.message);

          case 16:
            resBody = _appiumSupport.util.safeJsonParse(resBody);
            protocol = this.getProtocolFromResBody(resBody);

            if (!(protocol === MJSONWP)) {
              context$2$0.next = 28;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 21;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 21:
            _status = parseInt(resBody.status, 10);

            if (!(!isNaN(_status) && _status !== 0)) {
              context$2$0.next = 26;
              break;
            }

            message = resBody.value;

            if (_lodash2['default'].has(resBody.value, 'message')) {
              message = _lodash2['default'].isEmpty(message) ? resBody.value.message : message + ' ' + resBody.value.message;
            }
            throw (0, _protocolErrors.errorFromMJSONWPStatusCode)(_status, _lodash2['default'].isEmpty(message) ? (0, _jsonwpStatusStatus.getSummaryByCode)(_status) : message);

          case 26:
            context$2$0.next = 37;
            break;

          case 28:
            if (!(protocol === W3C)) {
              context$2$0.next = 35;
              break;
            }

            if (!(response.statusCode < 300)) {
              context$2$0.next = 31;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 31:
            if (!(_lodash2['default'].isPlainObject(resBody.value) && resBody.value.error)) {
              context$2$0.next = 33;
              break;
            }

            throw (0, _protocolErrors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);

          case 33:
            context$2$0.next = 37;
            break;

          case 35:
            if (!(response.statusCode === 200)) {
              context$2$0.next = 37;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 37:
            throw new _protocolErrors.errors.UnknownError('Did not know what to do with response code \'' + response.statusCode + '\' ' + ('and response body \'' + _lodash2['default'].truncate(JSON.stringify(resBody), { length: 300 }) + '\''));

          case 38:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 11]]);
    }
  }, {
    key: 'getSessionIdFromUrl',
    value: function getSessionIdFromUrl(url) {
      var match = url.match(/\/session\/([^\/]+)/);
      return match ? match[1] : null;
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var response, body, _ref5, _ref52, reqSessionId;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            response = undefined;
            body = undefined;
            context$2$0.prev = 2;
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap(this.proxyCommand(req.originalUrl, req.method, req.body));

          case 5:
            _ref5 = context$2$0.sent;
            _ref52 = _slicedToArray(_ref5, 2);
            response = _ref52[0];
            body = _ref52[1];
            context$2$0.next = 16;
            break;

          case 11:
            context$2$0.prev = 11;
            context$2$0.t0 = context$2$0['catch'](2);

            if (!(0, _protocolErrors.isErrorType)(context$2$0.t0, _protocolErrors.errors.ProxyRequestError)) {
              context$2$0.next = 15;
              break;
            }

            throw context$2$0.t0;

          case 15:
            throw new _protocolErrors.errors.UnknownError(context$2$0.t0.message);

          case 16:
            res.headers = response.headers;
            res.set('content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id from the request or from current session
            body = _appiumSupport.util.safeJsonParse(body);
            if (body && body.sessionId) {
              reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

              if (reqSessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + reqSessionId);
                body.sessionId = reqSessionId;
              } else if (this.sessionId) {
                log.info('Replacing sessionId ' + body.sessionId + ' with ' + this.sessionId);
                body.sessionId = this.sessionId;
              }
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[2, 11]]);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];

// Some servers, like chromedriver may return response code 200 for non-zero JSONWP statuses

// If we got a non-MJSONWP response, return the result, nothing left to do

// If we got an error, return the error right away

// ...Otherwise, continue to the next timeouts call

// No matches found. Proceed normally

// Got response in MJSONWP format

// Got response in W3C format

// Unknown protocol. Keeping it because of the backward compatibility

// this will be caught and translated upstream
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQUFjLFFBQVE7Ozs7NkJBQ08sZ0JBQWdCOzs4QkFDekIsaUJBQWlCOzs7O2tDQUNKLHlCQUF5Qjs7OEJBQzRCLG9CQUFvQjs7Z0NBQ25GLHNCQUFzQjs7Ozs4QkFDVixvQkFBb0I7O0FBR3ZELElBQU0sR0FBRyxHQUFHLHNCQUFPLFNBQVMsQ0FBQyxjQUFjLENBQUMsQ0FBQzs7QUFFN0MsSUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBQzVCLElBQU0sdUJBQXVCLEdBQUcsTUFBTSxDQUFDOztBQUV2QyxJQUFNLHNCQUFzQixHQUFHLENBQzdCO0FBQ0UsY0FBWSxFQUFFLENBQUMsU0FBUyxFQUFFLGNBQWMsQ0FBQztBQUN6QyxpQkFBZSxFQUFFLHlCQUFDLEdBQUc7V0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLGFBQWEsRUFDakQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxnQkFBZ0IsR0FBRyxVQUFVLENBQUM7R0FBQTtBQUN4RCxjQUFZLEVBQUUsc0JBQUMsR0FBRztXQUFLLEdBQUcsQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUM5QyxHQUFHLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLGdCQUFnQixHQUFHLGVBQWUsQ0FBQztHQUFBO0NBQzlELEVBQ0Q7QUFDRSxjQUFZLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQztBQUN0QyxpQkFBZSxFQUFFLHlCQUFDLEdBQUc7V0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLGtDQUFrQyxFQUN0RSxnQkFBZ0IsQ0FBQztHQUFBO0FBQ25CLGNBQVksRUFBRSxzQkFBQyxHQUFHO1dBQUssR0FBRyxDQUFDLE9BQU8sQ0FBQyx3QkFBd0IsRUFDekQsd0JBQXdCLENBQUM7R0FBQTtDQUM1QixDQUNGLENBQUM7O2tDQUVxQiw4QkFBVyxlQUFlO0lBQTFDLE9BQU8sK0JB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LENBQUM7QUFDekUsb0JBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztlQUNqQzthQUNGO0FBQ0QsZUFBRyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQzs7Ozs7OztLQUM1RDs7O1NBcllHLE9BQU87OztxQkF3WUUsT0FBTyIsImZpbGUiOiJsaWIvanNvbndwLXByb3h5L3Byb3h5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBnZXRTdW1tYXJ5QnlDb2RlIH0gZnJvbSAnLi4vanNvbndwLXN0YXR1cy9zdGF0dXMnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSwgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUsIGVycm9yRnJvbVczQ0pzb25Db2RlIH0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCB7IHJvdXRlVG9Db21tYW5kTmFtZSB9IGZyb20gJy4uL3Byb3RvY29sL3JvdXRlcyc7XG5cblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignSlNPTldQIFByb3h5Jyk7XG4vLyBUT0RPOiBNYWtlIHRoaXMgdmFsdWUgY29uZmlndXJhYmxlIGFzIGEgc2VydmVyIHNpZGUgY2FwYWJpbGl0eVxuY29uc3QgTE9HX09CSl9MRU5HVEggPSAxMDI0OyAvLyBNQVggTEVOR1RIIExvZ2dlZCB0byBmaWxlIC8gY29uc29sZVxuY29uc3QgREVGQVVMVF9SRVFVRVNUX1RJTUVPVVQgPSAyNDAwMDA7XG5cbmNvbnN0IENPTU1BTkRfVVJMU19DT05GTElDVFMgPSBbXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZXhlY3V0ZScsICdleGVjdXRlQXN5bmMnXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9leGVjdXRlLiovLFxuICAgICAgdXJsLmluY2x1ZGVzKCdhc3luYycpID8gJy9leGVjdXRlX2FzeW5jJyA6ICcvZXhlY3V0ZScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGUvYXN5bmMnIDogJy9leGVjdXRlL3N5bmMnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRFbGVtZW50U2NyZWVuc2hvdCddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2VsZW1lbnRcXC8oW15cXC9dKylcXC9zY3JlZW5zaG90JC8sXG4gICAgICAnL3NjcmVlbnNob3QvJDEnKSxcbiAgICB3M2NDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9zY3JlZW5zaG90XFwvKFteXFwvXSspLyxcbiAgICAgICcvZWxlbWVudC8kMS9zY3JlZW5zaG90JyksXG4gIH0sXG5dO1xuXG5jb25zdCB7TUpTT05XUCwgVzNDfSA9IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MO1xuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6ICcvd2QvaHViJyxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IERFRkFVTFRfUkVRVUVTVF9USU1FT1VULFxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICB9XG5cbiAgLy8gYWJzdHJhY3QgdGhlIGNhbGwgYmVoaW5kIGEgbWVtYmVyIGZ1bmN0aW9uXG4gIC8vIHNvIHRoYXQgd2UgY2FuIG1vY2sgaXQgaW4gdGVzdHNcbiAgYXN5bmMgcmVxdWVzdCAoLi4uYXJncykge1xuICAgIGNvbnN0IGN1cnJlbnRSZXF1ZXN0ID0gcmVxdWVzdCguLi5hcmdzKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5wdXNoKGN1cnJlbnRSZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgY3VycmVudFJlcXVlc3QuZmluYWxseSgoKSA9PiBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIGN1cnJlbnRSZXF1ZXN0KSk7XG4gIH1cblxuICBnZXRBY3RpdmVSZXF1ZXN0c0NvdW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlUmVxdWVzdHMubGVuZ3RoO1xuICB9XG5cbiAgY2FuY2VsQWN0aXZlUmVxdWVzdHMgKCkge1xuICAgIHRyeSB7XG4gICAgICBmb3IgKGxldCByIG9mIHRoaXMuX2FjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgIHIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBnZXRVcmxGb3JQcm94eSAodXJsKSB7XG4gICAgaWYgKHVybCA9PT0gJycpIHtcbiAgICAgIHVybCA9ICcvJztcbiAgICB9XG4gICAgY29uc3QgcHJveHlCYXNlID0gYCR7dGhpcy5zY2hlbWV9Oi8vJHt0aGlzLnNlcnZlcn06JHt0aGlzLnBvcnR9JHt0aGlzLmJhc2V9YDtcbiAgICBjb25zdCBlbmRwb2ludFJlID0gJygvKHNlc3Npb258c3RhdHVzKSknO1xuICAgIGxldCByZW1haW5pbmdVcmwgPSAnJztcbiAgICBpZiAoL15odHRwLy50ZXN0KHVybCkpIHtcbiAgICAgIGNvbnN0IGZpcnN0ID0gKG5ldyBSZWdFeHAoYChodHRwcz86Ly8uKykke2VuZHBvaW50UmV9YCkpLmV4ZWModXJsKTtcbiAgICAgIGlmICghZmlyc3QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdHb3QgYSBjb21wbGV0ZSB1cmwgYnV0IGNvdWxkIG5vdCBleHRyYWN0IEpXUCBlbmRwb2ludCcpO1xuICAgICAgfVxuICAgICAgcmVtYWluaW5nVXJsID0gdXJsLnJlcGxhY2UoZmlyc3RbMV0sICcnKTtcbiAgICB9IGVsc2UgaWYgKChuZXcgUmVnRXhwKCdeLycpKS50ZXN0KHVybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaWQgbm90IGtub3cgd2hhdCB0byBkbyB3aXRoIHVybCAnJHt1cmx9J2ApO1xuICAgIH1cblxuICAgIGNvbnN0IHN0cmlwUHJlZml4UmUgPSBuZXcgUmVnRXhwKCdeLio/KC8oc2Vzc2lvbnxzdGF0dXMpLiopJCcpO1xuICAgIGlmIChzdHJpcFByZWZpeFJlLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gc3RyaXBQcmVmaXhSZS5leGVjKHJlbWFpbmluZ1VybClbMV07XG4gICAgfVxuXG4gICAgaWYgKCEobmV3IFJlZ0V4cChlbmRwb2ludFJlKSkudGVzdChyZW1haW5pbmdVcmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSBgL3Nlc3Npb24vJHt0aGlzLnNlc3Npb25JZH0ke3JlbWFpbmluZ1VybH1gO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVpcmVzU2Vzc2lvbklkID0gdGhpcy5lbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkKHJlbWFpbmluZ1VybCk7XG5cbiAgICBpZiAocmVxdWlyZXNTZXNzaW9uSWQgJiYgdGhpcy5zZXNzaW9uSWQgPT09IG51bGwpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVHJ5aW5nIHRvIHByb3h5IGEgc2Vzc2lvbiBjb21tYW5kIHdpdGhvdXQgc2Vzc2lvbiBpZCcpO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb25CYXNlUmUgPSBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vKFteL10rKScpO1xuICAgIGlmIChzZXNzaW9uQmFzZVJlLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgLy8gd2UgaGF2ZSBzb21ldGhpbmcgbGlrZSAvc2Vzc2lvbi86aWQvZm9vYmFyLCBzbyB3ZSBuZWVkIHRvIHJlcGxhY2VcbiAgICAgIC8vIHRoZSBzZXNzaW9uIGlkXG4gICAgICBjb25zdCBtYXRjaCA9IHNlc3Npb25CYXNlUmUuZXhlYyhyZW1haW5pbmdVcmwpO1xuICAgICAgcmVtYWluaW5nVXJsID0gcmVtYWluaW5nVXJsLnJlcGxhY2UobWF0Y2hbMV0sIHRoaXMuc2Vzc2lvbklkKTtcbiAgICB9IGVsc2UgaWYgKHJlcXVpcmVzU2Vzc2lvbklkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBmaW5kIDpzZXNzaW9uIHNlY3Rpb24gZm9yIHVybDogJHtyZW1haW5pbmdVcmx9YCk7XG4gICAgfVxuICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKC9cXC8kLywgJycpOyAvLyBjYW4ndCBoYXZlIHRyYWlsaW5nIHNsYXNoZXNcblxuICAgIHJldHVybiBwcm94eUJhc2UgKyByZW1haW5pbmdVcmw7XG4gIH1cblxuICBhc3luYyBwcm94eSAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbWV0aG9kID0gbWV0aG9kLnRvVXBwZXJDYXNlKCk7XG4gICAgY29uc3QgbmV3VXJsID0gdGhpcy5nZXRVcmxGb3JQcm94eSh1cmwpO1xuICAgIGNvbnN0IHJlcU9wdHMgPSB7XG4gICAgICB1cmw6IG5ld1VybCxcbiAgICAgIG1ldGhvZCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgJ2NvbnRlbnQtdHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JyxcbiAgICAgICAgJ3VzZXItYWdlbnQnOiAnYXBwaXVtJyxcbiAgICAgICAgYWNjZXB0OiAnKi8qJyxcbiAgICAgIH0sXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICAgIGZvcmV2ZXI6IHRydWUsXG4gICAgfTtcbiAgICBpZiAoYm9keSAhPT0gbnVsbCkge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgfVxuXG4gICAgLy8gR0VUIG1ldGhvZHMgc2hvdWxkbid0IGhhdmUgYW55IGJvZHkuIE1vc3Qgc2VydmVycyBhcmUgT0sgd2l0aCB0aGlzLCBidXQgV2ViRHJpdmVyQWdlbnQgdGhyb3dzIDQwMCBlcnJvcnNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxT3B0cy5qc29uID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgXCIvXCJ9XSB0byBbJHttZXRob2R9ICR7bmV3VXJsfV0gYCArXG4gICAgICAgICAgICAgKGJvZHkgPyBgd2l0aCBib2R5OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoYm9keSksIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSl9YCA6ICd3aXRoIG5vIGJvZHknKSk7XG5cbiAgICBsZXQgcmVzLCByZXNCb2R5O1xuICAgIHRyeSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnJlcXVlc3QocmVxT3B0cyk7XG4gICAgICByZXNCb2R5ID0gcmVzLmJvZHk7XG4gICAgICBsb2cuZGVidWcoYEdvdCByZXNwb25zZSB3aXRoIHN0YXR1cyAke3Jlcy5zdGF0dXNDb2RlfTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc0JvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWApO1xuICAgICAgaWYgKC9cXC9zZXNzaW9uJC8udGVzdCh1cmwpICYmIG1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSByZXNCb2R5LnNlc3Npb25JZDtcbiAgICAgICAgfSBlbHNlIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMzAzKSB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSAvXFwvc2Vzc2lvblxcLyhbXlxcL10rKS8uZXhlYyhyZXNCb2R5KVsxXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc3QgcmVzQm9keU9iaiA9IHV0aWwuc2FmZUpzb25QYXJzZShyZXNCb2R5KTtcbiAgICAgIGlmICghdGhpcy5fZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5T2JqKTtcbiAgICAgIH1cbiAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA8IDQwMCAmJiB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgcGFyc2VJbnQocmVzQm9keU9iai5zdGF0dXMsIDEwKSAhPT0gMCkge1xuICAgICAgICAvLyBTb21lIHNlcnZlcnMsIGxpa2UgY2hyb21lZHJpdmVyIG1heSByZXR1cm4gcmVzcG9uc2UgY29kZSAyMDAgZm9yIG5vbi16ZXJvIEpTT05XUCBzdGF0dXNlc1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gYFRoZSByZXF1ZXN0IHRvICR7dXJsfSBoYXMgZmFpbGVkYDtcbiAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgICBlcnIubWVzc2FnZSA9IG1lc3NhZ2U7XG4gICAgICAgIGVyci5lcnJvciA9IHJlc0JvZHk7XG4gICAgICAgIGVyci5zdGF0dXNDb2RlID0gNTAwO1xuICAgICAgICB0aHJvdyBlcnI7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbGV0IHJlc3BvbnNlRXJyb3I7XG4gICAgICB0cnkge1xuICAgICAgICByZXNwb25zZUVycm9yID0gSlNPTi5wYXJzZShlLmVycm9yKTtcbiAgICAgIH0gY2F0Y2ggKGUxKSB7XG4gICAgICAgIGlmICghXy5pc0VtcHR5KGUuZXJyb3IpICYmIF8uaXNTdHJpbmcoZS5lcnJvcikpIHtcbiAgICAgICAgICBsb2cud2FybihgR290IGFuIHVuZXhwZWN0ZWQgcmVzcG9uc2U6ICR7Xy50cnVuY2F0ZShlLmVycm9yLCB7bGVuZ3RoOiAzMDB9KX1gKTtcbiAgICAgICAgfVxuICAgICAgICByZXNwb25zZUVycm9yID0gXy5pc1BsYWluT2JqZWN0KGUuZXJyb3IpID8gZS5lcnJvciA6IG51bGw7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKGBDb3VsZCBub3QgcHJveHkgY29tbWFuZCB0byByZW1vdGUgc2VydmVyLiBgICArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gLCByZXNwb25zZUVycm9yLCBlLnN0YXR1c0NvZGUpO1xuICAgIH1cbiAgICByZXR1cm4gW3JlcywgcmVzQm9keV07XG4gIH1cblxuICAvKipcbiAgICogVzNDIC90aW1lb3V0cyBjYW4gdGFrZSBhcyBtYW55IGFzIDMgdGltZW91dCB0eXBlcyBhdCBvbmNlLCBNSlNPTldQIC90aW1lb3V0cyBvbmx5IHRha2VzIG9uZVxuICAgKiBhdCBhIHRpbWUuIFNvIGlmIHdlJ3JlIHVzaW5nIFczQyBhbmQgcHJveHlpbmcgdG8gTUpTT05XUCBhbmQgdGhlcmUncyBtb3JlIHRoYW4gb25lIHRpbWVvdXQgdHlwZVxuICAgKiBwcm92aWRlZCBpbiB0aGUgcmVxdWVzdCwgd2UgbmVlZCB0byBkbyAzIHByb3hpZXMgYW5kIGNvbWJpbmUgdGhlIHJlc3VsdFxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gYm9keSBSZXF1ZXN0IGJvZHlcbiAgICogQHJldHVybiB7QXJyYXl9IEFycmF5IG9mIFczQyArIE1KU09OV1AgY29tcGF0aWJsZSB0aW1lb3V0IG9iamVjdHNcbiAgICovXG4gIGdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyAoYm9keSkge1xuICAgIGNvbnN0IHtwcm90b2NvbH0gPSBib2R5O1xuICAgIGNvbnN0IHRpbWVvdXRPYmplY3RzID0gW107XG4gICAgY29uc3QgYmFzZU9iaiA9IHtcbiAgICAgIHNjcmlwdDogYm9keS5zY3JpcHQsXG4gICAgICBwYWdlTG9hZDogYm9keS5wYWdlTG9hZCxcbiAgICAgIGltcGxpY2l0OiBib2R5LmltcGxpY2l0LFxuICAgIH07XG4gICAgaWYgKHByb3RvY29sID09PSBXM0MpIHtcbiAgICAgIGZvciAobGV0IFt0eXBlLCBtc10gb2YgXy50b1BhaXJzKGJhc2VPYmopKSB7XG4gICAgICAgIGlmIChfLmlzTnVtYmVyKG1zKSkge1xuICAgICAgICAgIHRpbWVvdXRPYmplY3RzLnB1c2goe1xuICAgICAgICAgICAgLi4uYmFzZU9iaixcbiAgICAgICAgICAgIHR5cGUsXG4gICAgICAgICAgICBtcyxcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRpbWVvdXRPYmplY3RzO1xuICAgIH1cblxuICAgIHJldHVybiBbe1xuICAgICAgLi4uYmFzZU9iaixcbiAgICAgIFtib2R5LnR5cGVdOiBib2R5Lm1zLFxuICAgICAgdHlwZTogYm9keS50eXBlLFxuICAgICAgbXM6IGJvZHkubXMsXG4gICAgfV07XG4gIH1cblxuICAvKipcbiAgICogUHJveHkgYW4gYXJyYXkgb2YgdGltZW91dCBvYmplY3RzIGFuZCBtZXJnZSB0aGUgcmVzdWx0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgRW5kcG9pbnQgdXJsXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgRW5kcG9pbnQgbWV0aG9kXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBib2R5IFJlcXVlc3QgYm9keVxuICAgKi9cbiAgYXN5bmMgcHJveHlTZXRUaW1lb3V0cyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBsZXQgcmVzcG9uc2UsIHJlc0JvZHk7XG4gICAgZm9yIChsZXQgdGltZW91dE9iaiBvZiB0aGlzLmdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyhib2R5KSkge1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIHRpbWVvdXRPYmopO1xuXG4gICAgICBsZXQgcHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keSk7XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhIG5vbi1NSlNPTldQIHJlc3BvbnNlLCByZXR1cm4gdGhlIHJlc3VsdCwgbm90aGluZyBsZWZ0IHRvIGRvXG4gICAgICBpZiAocHJvdG9jb2wgIT09IE1KU09OV1ApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhbiBlcnJvciwgcmV0dXJuIHRoZSBlcnJvciByaWdodCBhd2F5XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIC4uLk90aGVyd2lzZSwgY29udGludWUgdG8gdGhlIG5leHQgdGltZW91dHMgY2FsbFxuICAgIH1cbiAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgfVxuXG4gIGdldFByb3RvY29sRnJvbVJlc0JvZHkgKHJlc0JvZHkpIHtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChyZXNCb2R5KSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmVzQm9keSA9IEpTT04ucGFyc2UocmVzQm9keSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShyZXNCb2R5LnN0YXR1cykpIHtcbiAgICAgIHJldHVybiBNSlNPTldQO1xuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShyZXNCb2R5LnZhbHVlKSkge1xuICAgICAgcmV0dXJuIFczQztcbiAgICB9XG4gIH1cblxuICBhc3luYyBnZXREb3duc3RyZWFtUHJvdG9jb2wgKCkge1xuICAgIGlmICghdGhpcy5fZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICBjb25zdCBbLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHkoJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keSk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2w7XG4gIH1cblxuICByZXF1ZXN0VG9Db21tYW5kTmFtZSAodXJsLCBtZXRob2QpIHtcbiAgICBjb25zdCBleHRyYWN0Q29tbWFuZE5hbWUgPSAocGF0dGVybikgPT4ge1xuICAgICAgY29uc3QgcGF0aE1hdGNoID0gcGF0dGVybi5leGVjKHVybCk7XG4gICAgICByZXR1cm4gcGF0aE1hdGNoID8gcm91dGVUb0NvbW1hbmROYW1lKHBhdGhNYXRjaFsxXSwgbWV0aG9kKSA6IG51bGw7XG4gICAgfTtcbiAgICBsZXQgY29tbWFuZE5hbWUgPSByb3V0ZVRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QpO1xuICAgIGlmICghY29tbWFuZE5hbWUgJiYgXy5pbmNsdWRlcyh1cmwsICcvd2QvaHViL3Nlc3Npb24vJykpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKC9cXC93ZFxcL2h1YlxcL3Nlc3Npb25cXC9bXlxcL10rKC4rKS8pO1xuICAgIH1cbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCAnL3dkL2h1Yi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViKFxcLy4rKS8pO1xuICAgIH1cbiAgICByZXR1cm4gY29tbWFuZE5hbWU7XG4gIH1cblxuICBhc3luYyBwcm94eUNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGNvbnN0IGNvbW1hbmROYW1lID0gdGhpcy5yZXF1ZXN0VG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYE1hdGNoZWQgJyR7dXJsfScgdG8gY29tbWFuZCBuYW1lICcke2NvbW1hbmROYW1lfSdgKTtcblxuICAgIC8vIEhhbmRsZSBcImNyb3NzaW5nXCIgZW5kcG9pbnRzIGZvciB0aGUgY2FzZVxuICAgIC8vIHdoZW4gdXBzdHJlYW0gYW5kIGRvd25zdHJlYW0gZHJpdmVycyBvcGVyYXRlIGRpZmZlcmVudCBwcm90b2NvbHNcblxuICAgIC8vIFNhbWUgdXJsLCBidXQgZGlmZmVyZW50IGFyZ3VtZW50c1xuXG4gICAgaWYgKGNvbW1hbmROYW1lID09PSAndGltZW91dHMnKSAge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRUaW1lb3V0cyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuXG4gICAgLy8gU2FtZSBhcmd1bWVudHMsIGJ1dCBkaWZmZXJlbnQgVVJMc1xuXG4gICAgZm9yIChjb25zdCB7Y29tbWFuZE5hbWVzLCBqc29ud3BDb252ZXJ0ZXIsIHczY0NvbnZlcnRlcn0gb2YgQ09NTUFORF9VUkxTX0NPTkZMSUNUUykge1xuICAgICAgaWYgKCFjb21tYW5kTmFtZXMuaW5jbHVkZXMoY29tbWFuZE5hbWUpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBsZXQgZG93bnN0cmVhbVByb3RvY29sO1xuICAgICAgdHJ5IHtcbiAgICAgICAgZG93bnN0cmVhbVByb3RvY29sID0gYXdhaXQgdGhpcy5nZXREb3duc3RyZWFtUHJvdG9jb2woKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihlcnIpO1xuICAgICAgfVxuICAgICAgaWYgKCFkb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgICAgbG9nLndhcm4oJ1RoZSBkb3duc3RyZWFtIHByb3RvY29sIGNhbm5vdCBiZSBkZXRlY3RlZC4gUHJveHlpbmcgYXMgaXMnKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjb25zdCByZXdyaXR0ZW5VcmwgPSBkb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1BcbiAgICAgICAgPyBqc29ud3BDb252ZXJ0ZXIodXJsKVxuICAgICAgICA6IHczY0NvbnZlcnRlcih1cmwpO1xuICAgICAgaWYgKHJld3JpdHRlblVybCA9PT0gdXJsKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBrbm93IGhvdyB0byByZXdyaXRlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgYCArXG4gICAgICAgICAgYGZvciAke2Rvd25zdHJlYW1Qcm90b2NvbH0gcHJvdG9jb2xgKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBsb2cuaW5mbyhgUmV3cm90ZSB0aGUgb3JpZ2luYWwgVVJMICcke3VybH0nIHRvICcke3Jld3JpdHRlblVybH0nIGAgK1xuICAgICAgICBgZm9yICR7ZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkocmV3cml0dGVuVXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cblxuICAgIC8vIE5vIG1hdGNoZXMgZm91bmQuIFByb2NlZWQgbm9ybWFsbHlcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eSh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBhc3luYyBjb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBsZXQgcmVzcG9uc2U7XG4gICAgbGV0IHJlc0JvZHk7XG4gICAgdHJ5IHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIHRocm93IGVyci5nZXRBY3R1YWxFcnJvcigpO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXNCb2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKHJlc0JvZHkpO1xuICAgIGxldCBwcm90b2NvbCA9IHRoaXMuZ2V0UHJvdG9jb2xGcm9tUmVzQm9keShyZXNCb2R5KTtcbiAgICBpZiAocHJvdG9jb2wgPT09IE1KU09OV1ApIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBNSlNPTldQIGZvcm1hdFxuICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCAmJiByZXNCb2R5LnN0YXR1cyA9PT0gMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHN0YXR1cyA9IHBhcnNlSW50KHJlc0JvZHkuc3RhdHVzLCAxMCk7XG4gICAgICBpZiAoIWlzTmFOKHN0YXR1cykgJiYgc3RhdHVzICE9PSAwKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gcmVzQm9keS52YWx1ZTtcbiAgICAgICAgaWYgKF8uaGFzKHJlc0JvZHkudmFsdWUsICdtZXNzYWdlJykpIHtcbiAgICAgICAgICBtZXNzYWdlID0gXy5pc0VtcHR5KG1lc3NhZ2UpID8gcmVzQm9keS52YWx1ZS5tZXNzYWdlIDogYCR7bWVzc2FnZX0gJHtyZXNCb2R5LnZhbHVlLm1lc3NhZ2V9YDtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZShzdGF0dXMsIF8uaXNFbXB0eShtZXNzYWdlKSA/IGdldFN1bW1hcnlCeUNvZGUoc3RhdHVzKSA6IG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocHJvdG9jb2wgPT09IFczQykge1xuICAgICAgLy8gR290IHJlc3BvbnNlIGluIFczQyBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlIDwgMzAwKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5LnZhbHVlO1xuICAgICAgfVxuICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChyZXNCb2R5LnZhbHVlKSAmJiByZXNCb2R5LnZhbHVlLmVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yRnJvbVczQ0pzb25Db2RlKHJlc0JvZHkudmFsdWUuZXJyb3IsIHJlc0JvZHkudmFsdWUubWVzc2FnZSwgcmVzQm9keS52YWx1ZS5zdGFja3RyYWNlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgLy8gVW5rbm93biBwcm90b2NvbC4gS2VlcGluZyBpdCBiZWNhdXNlIG9mIHRoZSBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICAgICByZXR1cm4gcmVzQm9keTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggcmVzcG9uc2UgY29kZSAnJHtyZXNwb25zZS5zdGF0dXNDb2RlfScgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFuZCByZXNwb25zZSBib2R5ICcke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocmVzQm9keSksIHtsZW5ndGg6IDMwMH0pfSdgKTtcbiAgfVxuXG4gIGdldFNlc3Npb25JZEZyb21VcmwgKHVybCkge1xuICAgIGNvbnN0IG1hdGNoID0gdXJsLm1hdGNoKC9cXC9zZXNzaW9uXFwvKFteXFwvXSspLyk7XG4gICAgcmV0dXJuIG1hdGNoID8gbWF0Y2hbMV0gOiBudWxsO1xuICB9XG5cbiAgYXN5bmMgcHJveHlSZXFSZXMgKHJlcSwgcmVzKSB7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGxldCBib2R5O1xuICAgIHRyeSB7XG4gICAgICBbcmVzcG9uc2UsIGJvZHldID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQocmVxLm9yaWdpbmFsVXJsLCByZXEubWV0aG9kLCByZXEuYm9keSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoaXNFcnJvclR5cGUoZXJyLCBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IpKSB7XG4gICAgICAgIC8vIHRoaXMgd2lsbCBiZSBjYXVnaHQgYW5kIHRyYW5zbGF0ZWQgdXBzdHJlYW1cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoZXJyLm1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXMuaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7XG4gICAgcmVzLnNldCgnY29udGVudC10eXBlJywgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pO1xuICAgIC8vIGlmIHRoZSBwcm94aWVkIHJlc3BvbnNlIGNvbnRhaW5zIGEgc2Vzc2lvbklkIHRoYXQgdGhlIGRvd25zdHJlYW1cbiAgICAvLyBkcml2ZXIgaGFzIGdlbmVyYXRlZCwgd2UgZG9uJ3Qgd2FudCB0byByZXR1cm4gdGhhdCB0byB0aGUgY2xpZW50LlxuICAgIC8vIEluc3RlYWQsIHJldHVybiB0aGUgaWQgZnJvbSB0aGUgcmVxdWVzdCBvciBmcm9tIGN1cnJlbnQgc2Vzc2lvblxuICAgIGJvZHkgPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKGJvZHkgJiYgYm9keS5zZXNzaW9uSWQpIHtcbiAgICAgIGNvbnN0IHJlcVNlc3Npb25JZCA9IHRoaXMuZ2V0U2Vzc2lvbklkRnJvbVVybChyZXEub3JpZ2luYWxVcmwpO1xuICAgICAgaWYgKHJlcVNlc3Npb25JZCkge1xuICAgICAgICBsb2cuaW5mbyhgUmVwbGFjaW5nIHNlc3Npb25JZCAke2JvZHkuc2Vzc2lvbklkfSB3aXRoICR7cmVxU2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHJlcVNlc3Npb25JZDtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5zZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3RoaXMuc2Vzc2lvbklkfWApO1xuICAgICAgICBib2R5LnNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXMuc3RhdHVzKHJlc3BvbnNlLnN0YXR1c0NvZGUpLnNlbmQoSlNPTi5zdHJpbmdpZnkoYm9keSkpO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IEpXUHJveHk7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
