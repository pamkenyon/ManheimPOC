'use strict';

var _get = require('babel-runtime/helpers/get')['default'];

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _remoteDebugger = require('./remote-debugger');

var _remoteMessages = require('./remote-messages');

var _remoteMessages2 = _interopRequireDefault(_remoteMessages);

var _ws = require('ws');

var _ws2 = _interopRequireDefault(_ws);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _events = require('events');

var _events2 = _interopRequireDefault(_events);

var _helpers = require('./helpers');

var _es6Error = require('es6-error');

var _es6Error2 = _interopRequireDefault(_es6Error);

var _appiumSupport = require('appium-support');

var DATA_LOG_LENGTH = { length: 200 };

var WebKitRpcClient = (function (_events$EventEmitter) {
  _inherits(WebKitRpcClient, _events$EventEmitter);

  function WebKitRpcClient(host) {
    var port = arguments.length <= 1 || arguments[1] === undefined ? _remoteDebugger.REMOTE_DEBUGGER_PORT : arguments[1];
    var responseTimeout = arguments.length <= 2 || arguments[2] === undefined ? _remoteDebugger.RPC_RESPONSE_TIMEOUT_MS : arguments[2];

    _classCallCheck(this, WebKitRpcClient);

    _get(Object.getPrototypeOf(WebKitRpcClient.prototype), 'constructor', this).call(this);

    this.host = host || 'localhost';
    this.port = port;

    this.responseTimeout = responseTimeout;

    this.curMsgId = 0;

    this.dataHandlers = {};
    this.dataMethods = {};
    this.errorHandlers = {};
  }

  _createClass(WebKitRpcClient, [{
    key: 'connect',
    value: function connect(pageId) {
      return _regeneratorRuntime.async(function connect$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // we will only resolve this call when the socket is open
              // WebKit url
              var url = 'ws://' + _this.host + ':' + _this.port + '/devtools/page/' + pageId;
              _this.pageIdKey = pageId;

              // create and set up socket with appropriate event handlers
              _this.socket = new _ws2['default'](url);
              _this.socket.on('open', function () {
                _logger2['default'].debug('WebKit debugger web socket connected to url: ' + url);
                _this.connected = true;
                resolve();
              });
              _this.socket.on('close', function () {
                _logger2['default'].debug('WebKit remote debugger socket disconnected');
                _this.connected = false;
              });
              _this.socket.on('error', function (exception) {
                if (_this.connected) {
                  _logger2['default'].debug('WebKit debugger web socket error: ' + exception.message);
                  _this.connected = false;
                }

                reject(exception);
              });
              _this.socket.on('message', _this.receive.bind(_this));
            }));

          case 1:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'disconnect',
    value: function disconnect() {
      _logger2['default'].debug('Disconnecting from WebKit remote debugger');
      if (this.isConnected()) {
        this.socket.close(1001);
      }
      this.connected = false;
    }
  }, {
    key: 'isConnected',
    value: function isConnected() {
      return this.socket !== null && this.connected;
    }
  }, {
    key: 'send',
    value: function send(command) {
      var opts = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
      var data, id;
      return _regeneratorRuntime.async(function send$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            data = (0, _remoteMessages2['default'])(command, _lodash2['default'].defaults({ connId: this.connId, senderId: this.senderId }, opts));

            _logger2['default'].debug('Sending WebKit data: ' + _lodash2['default'].truncate(JSON.stringify(data), DATA_LOG_LENGTH));
            _logger2['default'].debug('Webkit response timeout: ' + this.responseTimeout);

            this.curMsgId++;
            data.id = this.curMsgId;

            id = this.curMsgId.toString();
            return context$2$0.abrupt('return', new _bluebird2['default'](function (resolve, reject) {
              // only resolve the send command when WebKit returns a response
              // store the handler and the data sent
              _this2.dataHandlers[id] = resolve;
              _this2.dataMethods[id] = data.method;
              _this2.errorHandlers[id] = reject;

              // send the data
              _this2.socket.send(JSON.stringify(data), function (error) {
                if (_appiumSupport.util.hasValue(error)) {
                  _logger2['default'].debug('WebKit socket error occurred: ' + error);
                  reject(new Error(error));
                }
              });
            })['catch'](WebKitRPCWarning, function (e) {
              _logger2['default'].info(e.message);
              _logger2['default'].info('Doing nothing');
              return _bluebird2['default'].resolve(null);
            })['finally'](function (res) {
              // no need to hold onto anything
              delete _this2.dataHandlers[id];
              delete _this2.dataMethods[id];
              delete _this2.errorHandlers[id];

              // and pass along the result
              return res;
            }).timeout(this.responseTimeout));

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'receive',
    value: function receive(data) {
      var _this3 = this;

      _logger2['default'].debug('Received WebKit data: \'' + _lodash2['default'].truncate(data, DATA_LOG_LENGTH) + '\'');
      data = _appiumSupport.util.safeJsonParse(data);

      var rejectCall = function rejectCall(error) {
        if (data && _this3.errorHandlers[data.id]) {
          return _this3.errorHandlers[data.id](error);
        }
        // this should not happen, but log at least
        _logger2['default'].errorAndThrow(error);
      };

      if (!_lodash2['default'].isPlainObject(data)) {
        return rejectCall(new WebKitRPCWarning('No parseable data found'));
      }

      // we can get an error, or we can get a response that is an error
      if (data.wasThrown || data.result && data.result.wasThrown) {
        var message = data.wasThrown ? data.result.value || data.result.description : data.result.result.value || data.result.result.description;
        return rejectCall(new Error(message));
      }

      var msgId = data.id;
      // when sending we set a data method and associated callback.
      // get that, or the generic (automatically sent, not associated
      // with a particular request) method
      var method = this.dataMethods[msgId] || data.method;
      if (!method) {
        return rejectCall(new WebKitRPCWarning('Did not find handler for the message'));
      }
      _logger2['default'].debug('Found method \'' + method + '\' ' + (msgId ? 'for message \'' + msgId + '\'' : ''));
      switch (method) {
        case 'Profiler.resetProfiles':
          _logger2['default'].debug('Device is telling us to reset profiles. Should probably ' + 'do some kind of callback here');
          break;
        case 'Timeline.eventRecorded':
          if (this.timelineEventHandler) {
            this.timelineEventHandler(data.result);
          }
          break;
        case 'Console.messageAdded':
          if (this.consoleEventHandler) {
            this.consoleEventHandler(data.params.message);
          }
          break;
        case 'Page.navigate':
          _logger2['default'].debug('Received page navigated message: ' + (0, _helpers.simpleStringify)(data));
          break;
        case 'Network.dataReceived':
        case 'Network.requestWillBeSent':
        case 'Network.responseReceived':
        case 'Network.loadingFinished':
        case 'Network.loadingFailed':
          if (_lodash2['default'].isFunction(this.networkEventHandler)) {
            this.networkEventHandler(method, data.params);
            return;
          }
          break;
      }
      if (!data.error && _lodash2['default'].has(this.dataHandlers, msgId)) {
        return this.dataHandlers[msgId](data.result);
      }
      if (data.error && _lodash2['default'].has(this.errorHandlers, msgId)) {
        return this.errorHandlers[msgId](data.error);
      }
      _logger2['default'].debug('There is no promise scheduled for method \'' + method + '\' in message \'' + msgId + '\'');
    }
  }, {
    key: 'setTimelineEventHandler',
    value: function setTimelineEventHandler(timelineEventHandler) {
      this.timelineEventHandler = timelineEventHandler;
    }
  }, {
    key: 'setConsoleLogEventHandler',
    value: function setConsoleLogEventHandler(consoleEventHandler) {
      this.consoleEventHandler = consoleEventHandler;
    }
  }, {
    key: 'setNetworkLogEventHandler',
    value: function setNetworkLogEventHandler(networkEventHandler) {
      this.networkEventHandler = networkEventHandler;
    }
  }]);

  return WebKitRpcClient;
})(_events2['default'].EventEmitter);

exports['default'] = WebKitRpcClient;

var WebKitRPCWarning = (function (_ES6Error) {
  _inherits(WebKitRPCWarning, _ES6Error);

  function WebKitRPCWarning() {
    _classCallCheck(this, WebKitRPCWarning);

    _get(Object.getPrototypeOf(WebKitRPCWarning.prototype), 'constructor', this).apply(this, arguments);
  }

  return WebKitRPCWarning;
})(_es6Error2['default']);

module.exports = exports['default'];
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZWJraXQtcnBjLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7c0JBQWdCLFVBQVU7Ozs7OEJBQ29DLG1CQUFtQjs7OEJBQ3BELG1CQUFtQjs7OztrQkFDMUIsSUFBSTs7Ozt3QkFDTixVQUFVOzs7O3NCQUNoQixRQUFROzs7O3NCQUNILFFBQVE7Ozs7dUJBQ0ssV0FBVzs7d0JBQ3RCLFdBQVc7Ozs7NkJBQ1gsZ0JBQWdCOztBQUdyQyxJQUFNLGVBQWUsR0FBRyxFQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQzs7SUFFakIsZUFBZTtZQUFmLGVBQWU7O0FBQ3RCLFdBRE8sZUFBZSxDQUNyQixJQUFJLEVBQTBFO1FBQXhFLElBQUk7UUFBeUIsZUFBZTs7MEJBRDVDLGVBQWU7O0FBRWhDLCtCQUZpQixlQUFlLDZDQUV4Qjs7QUFFUixRQUFJLENBQUMsSUFBSSxHQUFHLElBQUksSUFBSSxXQUFXLENBQUM7QUFDaEMsUUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWpCLFFBQUksQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDOztBQUV2QyxRQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQzs7QUFFbEIsUUFBSSxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7QUFDdkIsUUFBSSxDQUFDLFdBQVcsR0FBRyxFQUFFLENBQUM7QUFDdEIsUUFBSSxDQUFDLGFBQWEsR0FBRyxFQUFFLENBQUM7R0FDekI7O2VBZGtCLGVBQWU7O1dBZ0JwQixpQkFBQyxNQUFNOzs7Ozs7Z0RBQ1osMEJBQVksVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLOzs7QUFHdEMsa0JBQUksR0FBRyxhQUFXLE1BQUssSUFBSSxTQUFJLE1BQUssSUFBSSx1QkFBa0IsTUFBTSxBQUFFLENBQUM7QUFDbkUsb0JBQUssU0FBUyxHQUFHLE1BQU0sQ0FBQzs7O0FBR3hCLG9CQUFLLE1BQU0sR0FBRyxvQkFBYyxHQUFHLENBQUMsQ0FBQztB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Q0FBQztLQUNoRDs7O1dBRXlCLG1DQUFDLG1CQUFtQixFQUFFO0FBQzlDLFVBQUksQ0FBQyxtQkFBbUIsR0FBRyxtQkFBbUIsQ0FBQztLQUNoRDs7O1NBbExrQixlQUFlO0dBQVMsb0JBQU8sWUFBWTs7cUJBQTNDLGVBQWU7O0lBc0w5QixnQkFBZ0I7WUFBaEIsZ0JBQWdCOztXQUFoQixnQkFBZ0I7MEJBQWhCLGdCQUFnQjs7K0JBQWhCLGdCQUFnQjs7O1NBQWhCLGdCQUFnQiIsImZpbGUiOiJsaWIvd2Via2l0LXJwYy1jbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IFJFTU9URV9ERUJVR0dFUl9QT1JULCBSUENfUkVTUE9OU0VfVElNRU9VVF9NUyB9IGZyb20gJy4vcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCBnZXRSZW1vdGVDb21tYW5kIGZyb20gJy4vcmVtb3RlLW1lc3NhZ2VzJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IFByb21pc2UgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IHNpbXBsZVN0cmluZ2lmeSB9IGZyb20gJy4vaGVscGVycyc7XG5pbXBvcnQgRVM2RXJyb3IgZnJvbSAnZXM2LWVycm9yJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgREFUQV9MT0dfTEVOR1RIID0ge2xlbmd0aDogMjAwfTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2ViS2l0UnBjQ2xpZW50IGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yIChob3N0LCBwb3J0ID0gUkVNT1RFX0RFQlVHR0VSX1BPUlQsIHJlc3BvbnNlVGltZW91dCA9IFJQQ19SRVNQT05TRV9USU1FT1VUX01TKSB7XG4gICAgc3VwZXIoKTtcblxuICAgIHRoaXMuaG9zdCA9IGhvc3QgfHwgJ2xvY2FsaG9zdCc7XG4gICAgdGhpcy5wb3J0ID0gcG9ydDtcblxuICAgIHRoaXMucmVzcG9uc2VUaW1lb3V0ID0gcmVzcG9uc2VUaW1lb3V0O1xuXG4gICAgdGhpcy5jdXJNc2dJZCA9IDA7XG5cbiAgICB0aGlzLmRhdGFIYW5kbGVycyA9IHt9O1xuICAgIHRoaXMuZGF0YU1ldGhvZHMgPSB7fTtcbiAgICB0aGlzLmVycm9ySGFuZGxlcnMgPSB7fTtcbiAgfVxuXG4gIGFzeW5jIGNvbm5lY3QgKHBhZ2VJZCkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAvLyB3ZSB3aWxsIG9ubHkgcmVzb2x2ZSB0aGlzIGNhbGwgd2hlbiB0aGUgc29ja2V0IGlzIG9wZW5cbiAgICAgIC8vIFdlYktpdCB1cmxcbiAgICAgIGxldCB1cmwgPSBgd3M6Ly8ke3RoaXMuaG9zdH06JHt0aGlzLnBvcnR9L2RldnRvb2xzL3BhZ2UvJHtwYWdlSWR9YDtcbiAgICAgIHRoaXMucGFnZUlkS2V5ID0gcGFnZUlkO1xuXG4gICAgICAvLyBjcmVhdGUgYW5kIHNldCB1cCBzb2NrZXQgd2l0aCBhcHByb3ByaWF0ZSBldmVudCBoYW5kbGVyc1xuICAgICAgdGhpcy5zb2NrZXQgPSBuZXcgV2ViU29ja2V0KHVybCk7XG4gICAgICB0aGlzLnNvY2tldC5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKGBXZWJLaXQgZGVidWdnZXIgd2ViIHNvY2tldCBjb25uZWN0ZWQgdG8gdXJsOiAke3VybH1gKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICByZXNvbHZlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgICAgbG9nLmRlYnVnKCdXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyIHNvY2tldCBkaXNjb25uZWN0ZWQnKTtcbiAgICAgICAgdGhpcy5jb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ2Vycm9yJywgKGV4Y2VwdGlvbikgPT4ge1xuICAgICAgICBpZiAodGhpcy5jb25uZWN0ZWQpIHtcbiAgICAgICAgICBsb2cuZGVidWcoYFdlYktpdCBkZWJ1Z2dlciB3ZWIgc29ja2V0IGVycm9yOiAke2V4Y2VwdGlvbi5tZXNzYWdlfWApO1xuICAgICAgICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZWplY3QoZXhjZXB0aW9uKTtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zb2NrZXQub24oJ21lc3NhZ2UnLCB0aGlzLnJlY2VpdmUuYmluZCh0aGlzKSk7XG4gICAgfSk7XG4gIH1cblxuICBkaXNjb25uZWN0ICgpIHtcbiAgICBsb2cuZGVidWcoJ0Rpc2Nvbm5lY3RpbmcgZnJvbSBXZWJLaXQgcmVtb3RlIGRlYnVnZ2VyJyk7XG4gICAgaWYgKHRoaXMuaXNDb25uZWN0ZWQoKSkge1xuICAgICAgdGhpcy5zb2NrZXQuY2xvc2UoMTAwMSk7XG4gICAgfVxuICAgIHRoaXMuY29ubmVjdGVkID0gZmFsc2U7XG4gIH1cblxuICBpc0Nvbm5lY3RlZCAoKSB7XG4gICAgcmV0dXJuICh0aGlzLnNvY2tldCAhPT0gbnVsbCAmJiB0aGlzLmNvbm5lY3RlZCk7XG4gIH1cblxuICBhc3luYyBzZW5kIChjb21tYW5kLCBvcHRzID0ge30pIHtcbiAgICBsZXQgZGF0YSA9IGdldFJlbW90ZUNvbW1hbmQoY29tbWFuZCwgXy5kZWZhdWx0cyh7Y29ubklkOiB0aGlzLmNvbm5JZCwgc2VuZGVySWQ6IHRoaXMuc2VuZGVySWR9LCBvcHRzKSk7XG5cbiAgICBsb2cuZGVidWcoYFNlbmRpbmcgV2ViS2l0IGRhdGE6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShkYXRhKSwgREFUQV9MT0dfTEVOR1RIKX1gKTtcbiAgICBsb2cuZGVidWcoYFdlYmtpdCByZXNwb25zZSB0aW1lb3V0OiAke3RoaXMucmVzcG9uc2VUaW1lb3V0fWApO1xuXG4gICAgdGhpcy5jdXJNc2dJZCsrO1xuICAgIGRhdGEuaWQgPSB0aGlzLmN1ck1zZ0lkO1xuXG4gICAgY29uc3QgaWQgPSB0aGlzLmN1ck1zZ0lkLnRvU3RyaW5nKCk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIC8vIG9ubHkgcmVzb2x2ZSB0aGUgc2VuZCBjb21tYW5kIHdoZW4gV2ViS2l0IHJldHVybnMgYSByZXNwb25zZVxuICAgICAgLy8gc3RvcmUgdGhlIGhhbmRsZXIgYW5kIHRoZSBkYXRhIHNlbnRcbiAgICAgIHRoaXMuZGF0YUhhbmRsZXJzW2lkXSA9IHJlc29sdmU7XG4gICAgICB0aGlzLmRhdGFNZXRob2RzW2lkXSA9IGRhdGEubWV0aG9kO1xuICAgICAgdGhpcy5lcnJvckhhbmRsZXJzW2lkXSA9IHJlamVjdDtcblxuICAgICAgLy8gc2VuZCB0aGUgZGF0YVxuICAgICAgdGhpcy5zb2NrZXQuc2VuZChKU09OLnN0cmluZ2lmeShkYXRhKSwgZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGVycm9yKSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZyhgV2ViS2l0IHNvY2tldCBlcnJvciBvY2N1cnJlZDogJHtlcnJvcn1gKTtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGVycm9yKSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pLmNhdGNoKFdlYktpdFJQQ1dhcm5pbmcsIChlKSA9PiB7XG4gICAgICBsb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgbG9nLmluZm8oJ0RvaW5nIG5vdGhpbmcnKTtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobnVsbCk7XG4gICAgfSkuZmluYWxseSgocmVzKSA9PiB7XG4gICAgICAvLyBubyBuZWVkIHRvIGhvbGQgb250byBhbnl0aGluZ1xuICAgICAgZGVsZXRlIHRoaXMuZGF0YUhhbmRsZXJzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmRhdGFNZXRob2RzW2lkXTtcbiAgICAgIGRlbGV0ZSB0aGlzLmVycm9ySGFuZGxlcnNbaWRdO1xuXG4gICAgICAvLyBhbmQgcGFzcyBhbG9uZyB0aGUgcmVzdWx0XG4gICAgICByZXR1cm4gcmVzO1xuICAgIH0pLnRpbWVvdXQodGhpcy5yZXNwb25zZVRpbWVvdXQpO1xuICB9XG5cbiAgcmVjZWl2ZSAoZGF0YSkge1xuICAgIGxvZy5kZWJ1ZyhgUmVjZWl2ZWQgV2ViS2l0IGRhdGE6ICcke18udHJ1bmNhdGUoZGF0YSwgREFUQV9MT0dfTEVOR1RIKX0nYCk7XG4gICAgZGF0YSA9IHV0aWwuc2FmZUpzb25QYXJzZShkYXRhKTtcblxuICAgIGNvbnN0IHJlamVjdENhbGwgPSAoZXJyb3IpID0+IHtcbiAgICAgIGlmIChkYXRhICYmIHRoaXMuZXJyb3JIYW5kbGVyc1tkYXRhLmlkXSkge1xuICAgICAgICByZXR1cm4gdGhpcy5lcnJvckhhbmRsZXJzW2RhdGEuaWRdKGVycm9yKTtcbiAgICAgIH1cbiAgICAgIC8vIHRoaXMgc2hvdWxkIG5vdCBoYXBwZW4sIGJ1dCBsb2cgYXQgbGVhc3RcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGVycm9yKTtcbiAgICB9O1xuXG4gICAgaWYgKCFfLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcbiAgICAgIHJldHVybiByZWplY3RDYWxsKG5ldyBXZWJLaXRSUENXYXJuaW5nKGBObyBwYXJzZWFibGUgZGF0YSBmb3VuZGApKTtcbiAgICB9XG5cbiAgICAvLyB3ZSBjYW4gZ2V0IGFuIGVycm9yLCBvciB3ZSBjYW4gZ2V0IGEgcmVzcG9uc2UgdGhhdCBpcyBhbiBlcnJvclxuICAgIGlmIChkYXRhLndhc1Rocm93biB8fCAoZGF0YS5yZXN1bHQgJiYgZGF0YS5yZXN1bHQud2FzVGhyb3duKSkge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGRhdGEud2FzVGhyb3duXG4gICAgICAgID8gZGF0YS5yZXN1bHQudmFsdWUgfHwgZGF0YS5yZXN1bHQuZGVzY3JpcHRpb25cbiAgICAgICAgOiBkYXRhLnJlc3VsdC5yZXN1bHQudmFsdWUgfHwgZGF0YS5yZXN1bHQucmVzdWx0LmRlc2NyaXB0aW9uO1xuICAgICAgcmV0dXJuIHJlamVjdENhbGwobmV3IEVycm9yKG1lc3NhZ2UpKTtcbiAgICB9XG5cbiAgICBjb25zdCBtc2dJZCA9IGRhdGEuaWQ7XG4gICAgLy8gd2hlbiBzZW5kaW5nIHdlIHNldCBhIGRhdGEgbWV0aG9kIGFuZCBhc3NvY2lhdGVkIGNhbGxiYWNrLlxuICAgIC8vIGdldCB0aGF0LCBvciB0aGUgZ2VuZXJpYyAoYXV0b21hdGljYWxseSBzZW50LCBub3QgYXNzb2NpYXRlZFxuICAgIC8vIHdpdGggYSBwYXJ0aWN1bGFyIHJlcXVlc3QpIG1ldGhvZFxuICAgIGNvbnN0IG1ldGhvZCA9IHRoaXMuZGF0YU1ldGhvZHNbbXNnSWRdIHx8IGRhdGEubWV0aG9kO1xuICAgIGlmICghbWV0aG9kKSB7XG4gICAgICByZXR1cm4gcmVqZWN0Q2FsbChuZXcgV2ViS2l0UlBDV2FybmluZygnRGlkIG5vdCBmaW5kIGhhbmRsZXIgZm9yIHRoZSBtZXNzYWdlJykpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEZvdW5kIG1ldGhvZCAnJHttZXRob2R9JyAke21zZ0lkID8gYGZvciBtZXNzYWdlICcke21zZ0lkfSdgIDogJyd9YCk7XG4gICAgc3dpdGNoIChtZXRob2QpIHtcbiAgICAgIGNhc2UgJ1Byb2ZpbGVyLnJlc2V0UHJvZmlsZXMnOlxuICAgICAgICBsb2cuZGVidWcoJ0RldmljZSBpcyB0ZWxsaW5nIHVzIHRvIHJlc2V0IHByb2ZpbGVzLiBTaG91bGQgcHJvYmFibHkgJyArXG4gICAgICAgICAgICAgICAgICAnZG8gc29tZSBraW5kIG9mIGNhbGxiYWNrIGhlcmUnKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdUaW1lbGluZS5ldmVudFJlY29yZGVkJzpcbiAgICAgICAgaWYgKHRoaXMudGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICAgICAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyKGRhdGEucmVzdWx0KTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ0NvbnNvbGUubWVzc2FnZUFkZGVkJzpcbiAgICAgICAgaWYgKHRoaXMuY29uc29sZUV2ZW50SGFuZGxlcikge1xuICAgICAgICAgIHRoaXMuY29uc29sZUV2ZW50SGFuZGxlcihkYXRhLnBhcmFtcy5tZXNzYWdlKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ1BhZ2UubmF2aWdhdGUnOlxuICAgICAgICBsb2cuZGVidWcoYFJlY2VpdmVkIHBhZ2UgbmF2aWdhdGVkIG1lc3NhZ2U6ICR7c2ltcGxlU3RyaW5naWZ5KGRhdGEpfWApO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ05ldHdvcmsuZGF0YVJlY2VpdmVkJzpcbiAgICAgIGNhc2UgJ05ldHdvcmsucmVxdWVzdFdpbGxCZVNlbnQnOlxuICAgICAgY2FzZSAnTmV0d29yay5yZXNwb25zZVJlY2VpdmVkJzpcbiAgICAgIGNhc2UgJ05ldHdvcmsubG9hZGluZ0ZpbmlzaGVkJzpcbiAgICAgIGNhc2UgJ05ldHdvcmsubG9hZGluZ0ZhaWxlZCc6XG4gICAgICAgIGlmIChfLmlzRnVuY3Rpb24odGhpcy5uZXR3b3JrRXZlbnRIYW5kbGVyKSkge1xuICAgICAgICAgIHRoaXMubmV0d29ya0V2ZW50SGFuZGxlcihtZXRob2QsIGRhdGEucGFyYW1zKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGlmICghZGF0YS5lcnJvciAmJiBfLmhhcyh0aGlzLmRhdGFIYW5kbGVycywgbXNnSWQpKSB7XG4gICAgICByZXR1cm4gdGhpcy5kYXRhSGFuZGxlcnNbbXNnSWRdKGRhdGEucmVzdWx0KTtcbiAgICB9XG4gICAgaWYgKGRhdGEuZXJyb3IgJiYgXy5oYXModGhpcy5lcnJvckhhbmRsZXJzLCBtc2dJZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmVycm9ySGFuZGxlcnNbbXNnSWRdKGRhdGEuZXJyb3IpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYFRoZXJlIGlzIG5vIHByb21pc2Ugc2NoZWR1bGVkIGZvciBtZXRob2QgJyR7bWV0aG9kfScgaW4gbWVzc2FnZSAnJHttc2dJZH0nYCk7XG4gIH1cblxuICBzZXRUaW1lbGluZUV2ZW50SGFuZGxlciAodGltZWxpbmVFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLnRpbWVsaW5lRXZlbnRIYW5kbGVyID0gdGltZWxpbmVFdmVudEhhbmRsZXI7XG4gIH1cblxuICBzZXRDb25zb2xlTG9nRXZlbnRIYW5kbGVyIChjb25zb2xlRXZlbnRIYW5kbGVyKSB7XG4gICAgdGhpcy5jb25zb2xlRXZlbnRIYW5kbGVyID0gY29uc29sZUV2ZW50SGFuZGxlcjtcbiAgfVxuXG4gIHNldE5ldHdvcmtMb2dFdmVudEhhbmRsZXIgKG5ldHdvcmtFdmVudEhhbmRsZXIpIHtcbiAgICB0aGlzLm5ldHdvcmtFdmVudEhhbmRsZXIgPSBuZXR3b3JrRXZlbnRIYW5kbGVyO1xuICB9XG59XG5cblxuY2xhc3MgV2ViS2l0UlBDV2FybmluZyBleHRlbmRzIEVTNkVycm9yIHt9XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uIn0=
