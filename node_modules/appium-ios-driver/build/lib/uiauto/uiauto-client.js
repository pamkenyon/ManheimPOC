// The Command Proxy relays UIAuto message to and from Appium. It is also the
// UIAuto facade for Appium.
//
// The message route is the following:
// Appium <--> Command Proxy <--> Instruments
// The medium between Instruments and Command Proxy is the command-proxy-client
// script.
//
// Command Proxy --> Instruments message format: {cmd:"<CMD>"}
//
// Instruments --> Command Proxy message format:
// <one char message type>,<stringified json data>
// <stringified json data> format:
// {status:<status>, value:<result>}

'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _uiautoResponse = require('./uiauto-response');

var _uiautoResponse2 = _interopRequireDefault(_uiautoResponse);

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _through = require('through');

var _through2 = _interopRequireDefault(_through);

var _net = require('net');

var _net2 = _interopRequireDefault(_net);

var _appiumSupport = require('appium-support');

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _appiumBaseDriver = require('appium-base-driver');

var MORE_COMMAND = '#more';
var DEFAULT_INSTRUMENTS_SOCKET = '/tmp/instruments_sock';

var UIAutoClient = (function () {
  function UIAutoClient() {
    var sock = arguments.length <= 0 || arguments[0] === undefined ? '/tmp/instruments_sock' : arguments[0];

    _classCallCheck(this, UIAutoClient);

    this.curCommand = null;
    this.onReceiveCommand = null;
    this.commandQueue = [];
    this.sock = sock;
    this.socketServer = null;
    this.hasConnected = false;
    this.currentSocket = null;
  }

  _createClass(UIAutoClient, [{
    key: 'sendCommand',
    value: function sendCommand(cmd) {
      var cmdPromise;
      return _regeneratorRuntime.async(function sendCommand$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmdPromise = new _bluebird2['default'](function (resolve, reject) {
              var cb = function cb(result) {
                // get back a JSONWP object, so decode and
                // just return the value
                if (result.status === 0) {
                  resolve(result.value);
                } else if (result.status) {
                  var jsonwpError = (0, _appiumBaseDriver.errorFromCode)(result.status, result.value);
                  reject(jsonwpError);
                } else {
                  reject(new Error(result.value));
                }
              };
              _this.commandQueue.push({ cmd: cmd, cb: cb });
              if (_lodash2['default'].isFunction(_this.onReceiveCommand)) {
                _this.onReceiveCommand();
              }
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(cmdPromise);

          case 3:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 4:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }

    /*
     * Returns true if the resulting connecting is the first
     * socket connection for this proxy session
     */
  }, {
    key: 'start',
    value: function start() {
      var connectedPromise;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this2 = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            connectedPromise = new _bluebird2['default'](function (resolve) {
              var response = new _uiautoResponse2['default']();
              _this2.socketServer = _net2['default'].createServer({ allowHalfOpen: true }, function (conn) {
                if (!_this2.hasConnected) {
                  _this2.hasConnected = true;
                  _logger2['default'].info('Instruments is ready to receive commands');
                  resolve(true);
                }
                // up with strings! down with buffers!
                conn.setEncoding('utf8');

                // keep track of this so that we can destroy the socket
                // when shutting down
                _this2.currentSocket = conn;

                conn.on('close', function () {
                  _this2.currentSocket = null;
                });

                // all data goes into buffer
                conn.pipe((0, _through2['default'])(function (data) {
                  _logger2['default'].debug('Socket data received (' + data.length + ' bytes)');
                  response.addData(data);
                }));

                // when all data is in, deal with it
                conn.on('end', function () {
                  // if we are midway through handling a command
                  // we want to try out the data, getting more if necessary
                  if (_this2.curCommand) {
                    var result = response.getResult();
                    if (result && !result.needsMoreData) {
                      // if we're done altogether, call the callback associated with the command
                      _this2.curCommand.cb(result);
                      _this2.curCommand = null;
                    } else {
                      if (result) {
                        _logger2['default'].debug('Not the last chunk, trying to get more');
                      } else {
                        _logger2['default'].debug('No result received. Continuing to try to get more');
                      }
                      // add a command to the queue, to request more data
                      _this2.commandQueue.unshift({ cmd: MORE_COMMAND, cb: _this2.curCommand.cb });
                    }
                  } else {
                    _logger2['default'].debug('Got a result when we were not expecting one! Ignoring it');
                    response.resetBuffer();
                  }

                  // set up a callback to handle the next command
                  var onReceiveCommand = function onReceiveCommand() {
                    _this2.onReceiveCommand = null;
                    _this2.curCommand = _this2.commandQueue.shift();
                    _logger2['default'].debug('Sending command to instruments: ' + _this2.curCommand.cmd);
                    conn.write(JSON.stringify({ cmd: _this2.curCommand.cmd }));
                    conn.end();
                  };
                  if (_this2.commandQueue.length) {
                    onReceiveCommand();
                  } else {
                    _this2.onReceiveCommand = onReceiveCommand;
                  }
                });
              });

              _this2.socketServer.on('close', function () {
                _logger2['default'].debug('Instruments socket server was closed');
              });
            });
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.rimraf(this.sock));

          case 3:
            context$2$0.next = 5;
            return _regeneratorRuntime.awrap((0, _appiumSupport.mkdirp)(_path2['default'].dirname(this.sock)));

          case 5:

            this.socketServer.listen(this.sock);
            _logger2['default'].debug('Instruments socket server started at ' + this.sock);

            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(connectedPromise);

          case 9:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 10:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'shutdown',
    value: function shutdown() {
      return _regeneratorRuntime.async(function shutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            // make sure clear out command cbs so we can't have any lingering cbs
            // if a socket request makes it through after exit somehow
            this.curCommand = null;
            this.onReceiveCommand = null;

            if (this.currentSocket) {
              _logger2['default'].debug('Destroying instruments client socket.');
              this.currentSocket.end();
              this.currentSocket.destroy();
              this.currentSocket = null;
            }

            if (!this.socketServer) {
              context$2$0.next = 8;
              break;
            }

            _logger2['default'].debug('Closing socket server.');
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap(_bluebird2['default'].promisify(this.socketServer.close, { context: this.socketServer })());

          case 7:
            this.socketServer = null;

          case 8:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'safeShutdown',
    value: function safeShutdown() {
      return _regeneratorRuntime.async(function safeShutdown$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Shutting down command proxy and ignoring any errors');
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.shutdown());

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].debug('Ignoring error: ' + context$2$0.t0);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return UIAutoClient;
})();

exports.UIAutoClient = UIAutoClient;
exports.DEFAULT_INSTRUMENTS_SOCKET = DEFAULT_INSTRUMENTS_SOCKET;
exports['default'] = UIAutoClient;

// only resolve the promise when the server that is created actually connects

// remove socket file if it currently exists

// create the new socket file
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG8vdWlhdXRvLWNsaWVudC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs4QkFlMkIsbUJBQW1COzs7O3NCQUMzQixVQUFVOzs7O3VCQUNULFNBQVM7Ozs7bUJBQ2IsS0FBSzs7Ozs2QkFDTSxnQkFBZ0I7O29CQUMxQixNQUFNOzs7O3dCQUNULFVBQVU7Ozs7c0JBQ1YsUUFBUTs7OztnQ0FDUSxvQkFBb0I7O0FBR2xELElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQztBQUM3QixJQUFNLDBCQUEwQixHQUFHLHVCQUF1QixDQUFDOztJQUVyRCxZQUFZO0FBQ0osV0FEUixZQUFZLEdBQzZCO1FBQWhDLElBQUkseURBQUcsdUJBQXVCOzswQkFEdkMsWUFBWTs7QUFFZCxRQUFJLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztBQUN2QixRQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBQzdCLFFBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsS0FBSyxDQUFDO0FBQzFCLFFBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDO0dBQzNCOztlQVRHLFlBQVk7O1dBV0UscUJBQUMsR0FBRztVQUNoQixVQUFVOzs7Ozs7QUFBVixzQkFBVSxHQUFHLDBCQUFNLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSztBQUMxQyxrQkFBSSxFQUFFLEdBQUcsU0FBTCxFQUFFLENBQUksTUFBTSxFQUFLOzs7QUFHbkIsb0JBQUksTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7QUFDdkIseUJBQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ3ZCLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxFQUFFO0FBQ3hC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QzdCLGtCQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQzthQUMzQjs7aUJBQ0csSUFBSSxDQUFDLFlBQVk7Ozs7O0FBQ25CLGdDQUFPLEtBQUssQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOzs2Q0FDakMsQUFBQyxzQkFBRSxTQUFTLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsRUFBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBQyxDQUFDLEVBQUc7OztBQUM1RSxnQkFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUM7Ozs7Ozs7S0FFNUI7OztXQUVrQjs7OztBQUNqQixnQ0FBTyxLQUFLLENBQUMscURBQXFELENBQUMsQ0FBQzs7OzZDQUU1RCxJQUFJLENBQUMsUUFBUSxFQUFFOzs7Ozs7Ozs7O0FBRXJCLGdDQUFPLEtBQUsscUNBQTBCLENBQUM7Ozs7Ozs7S0FFMUM7OztTQW5KRyxZQUFZOzs7UUFzSlQsWUFBWSxHQUFaLFlBQVk7UUFBRSwwQkFBMEIsR0FBMUIsMEJBQTBCO3FCQUNsQyxZQUFZIiwiZmlsZSI6ImxpYi91aWF1dG8vdWlhdXRvLWNsaWVudC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoZSBDb21tYW5kIFByb3h5IHJlbGF5cyBVSUF1dG8gbWVzc2FnZSB0byBhbmQgZnJvbSBBcHBpdW0uIEl0IGlzIGFsc28gdGhlXG4vLyBVSUF1dG8gZmFjYWRlIGZvciBBcHBpdW0uXG4vL1xuLy8gVGhlIG1lc3NhZ2Ugcm91dGUgaXMgdGhlIGZvbGxvd2luZzpcbi8vIEFwcGl1bSA8LS0+IENvbW1hbmQgUHJveHkgPC0tPiBJbnN0cnVtZW50c1xuLy8gVGhlIG1lZGl1bSBiZXR3ZWVuIEluc3RydW1lbnRzIGFuZCBDb21tYW5kIFByb3h5IGlzIHRoZSBjb21tYW5kLXByb3h5LWNsaWVudFxuLy8gc2NyaXB0LlxuLy9cbi8vIENvbW1hbmQgUHJveHkgLS0+IEluc3RydW1lbnRzIG1lc3NhZ2UgZm9ybWF0OiB7Y21kOlwiPENNRD5cIn1cbi8vXG4vLyBJbnN0cnVtZW50cyAtLT4gQ29tbWFuZCBQcm94eSBtZXNzYWdlIGZvcm1hdDpcbi8vIDxvbmUgY2hhciBtZXNzYWdlIHR5cGU+LDxzdHJpbmdpZmllZCBqc29uIGRhdGE+XG4vLyA8c3RyaW5naWZpZWQganNvbiBkYXRhPiBmb3JtYXQ6XG4vLyB7c3RhdHVzOjxzdGF0dXM+LCB2YWx1ZTo8cmVzdWx0Pn1cblxuaW1wb3J0IFVJQXV0b1Jlc3BvbnNlIGZyb20gJy4vdWlhdXRvLXJlc3BvbnNlJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHRocm91Z2ggZnJvbSAndGhyb3VnaCc7XG5pbXBvcnQgbmV0IGZyb20gJ25ldCc7XG5pbXBvcnQgeyBta2RpcnAsIGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JGcm9tQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5cblxuY29uc3QgTU9SRV9DT01NQU5EID0gJyNtb3JlJztcbmNvbnN0IERFRkFVTFRfSU5TVFJVTUVOVFNfU09DS0VUID0gJy90bXAvaW5zdHJ1bWVudHNfc29jayc7XG5cbmNsYXNzIFVJQXV0b0NsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChzb2NrID0gJy90bXAvaW5zdHJ1bWVudHNfc29jaycpIHtcbiAgICB0aGlzLmN1ckNvbW1hbmQgPSBudWxsO1xuICAgIHRoaXMub25SZWNlaXZlQ29tbWFuZCA9IG51bGw7XG4gICAgdGhpcy5jb21tYW5kUXVldWUgPSBbXTtcbiAgICB0aGlzLnNvY2sgPSBzb2NrO1xuICAgIHRoaXMuc29ja2V0U2VydmVyID0gbnVsbDtcbiAgICB0aGlzLmhhc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgIHRoaXMuY3VycmVudFNvY2tldCA9IG51bGw7XG4gIH1cblxuICBhc3luYyBzZW5kQ29tbWFuZCAoY21kKSB7XG4gICAgbGV0IGNtZFByb21pc2UgPSBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBsZXQgY2IgPSAocmVzdWx0KSA9PiB7XG4gICAgICAgIC8vIGdldCBiYWNrIGEgSlNPTldQIG9iamVjdCwgc28gZGVjb2RlIGFuZFxuICAgICAgICAvLyBqdXN0IHJldHVybiB0aGUgdmFsdWVcbiAgICAgICAgaWYgKHJlc3VsdC5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICByZXNvbHZlKHJlc3VsdC52YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzdWx0LnN0YXR1cykge1xuICAgICAgICAgIGxldCBqc29ud3BFcnJvciA9IGVycm9yRnJvbUNvZGUocmVzdWx0LnN0YXR1cywgcmVzdWx0LnZhbHVlKTtcbiAgICAgICAgICByZWplY3QoanNvbndwRXJyb3IpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IocmVzdWx0LnZhbHVlKSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgICB0aGlzLmNvbW1hbmRRdWV1ZS5wdXNoKHtjbWQsIGNifSk7XG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKHRoaXMub25SZWNlaXZlQ29tbWFuZCkpIHtcbiAgICAgICAgdGhpcy5vblJlY2VpdmVDb21tYW5kKCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGF3YWl0IGNtZFByb21pc2U7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRydWUgaWYgdGhlIHJlc3VsdGluZyBjb25uZWN0aW5nIGlzIHRoZSBmaXJzdFxuICAgKiBzb2NrZXQgY29ubmVjdGlvbiBmb3IgdGhpcyBwcm94eSBzZXNzaW9uXG4gICAqL1xuICBhc3luYyBzdGFydCAoKSB7XG4gICAgLy8gb25seSByZXNvbHZlIHRoZSBwcm9taXNlIHdoZW4gdGhlIHNlcnZlciB0aGF0IGlzIGNyZWF0ZWQgYWN0dWFsbHkgY29ubmVjdHNcbiAgICBsZXQgY29ubmVjdGVkUHJvbWlzZSA9IG5ldyBCKChyZXNvbHZlKSA9PiB7XG4gICAgICBsZXQgcmVzcG9uc2UgPSBuZXcgVUlBdXRvUmVzcG9uc2UoKTtcbiAgICAgIHRoaXMuc29ja2V0U2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcih7YWxsb3dIYWxmT3BlbjogdHJ1ZX0sIChjb25uKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5oYXNDb25uZWN0ZWQpIHtcbiAgICAgICAgICB0aGlzLmhhc0Nvbm5lY3RlZCA9IHRydWU7XG4gICAgICAgICAgbG9nZ2VyLmluZm8oJ0luc3RydW1lbnRzIGlzIHJlYWR5IHRvIHJlY2VpdmUgY29tbWFuZHMnKTtcbiAgICAgICAgICByZXNvbHZlKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIC8vIHVwIHdpdGggc3RyaW5ncyEgZG93biB3aXRoIGJ1ZmZlcnMhXG4gICAgICAgIGNvbm4uc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcblxuICAgICAgICAvLyBrZWVwIHRyYWNrIG9mIHRoaXMgc28gdGhhdCB3ZSBjYW4gZGVzdHJveSB0aGUgc29ja2V0XG4gICAgICAgIC8vIHdoZW4gc2h1dHRpbmcgZG93blxuICAgICAgICB0aGlzLmN1cnJlbnRTb2NrZXQgPSBjb25uO1xuXG4gICAgICAgIGNvbm4ub24oJ2Nsb3NlJywgKCkgPT4ge1xuICAgICAgICAgIHRoaXMuY3VycmVudFNvY2tldCA9IG51bGw7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIGFsbCBkYXRhIGdvZXMgaW50byBidWZmZXJcbiAgICAgICAgY29ubi5waXBlKHRocm91Z2goKGRhdGEpID0+IHtcbiAgICAgICAgICBsb2dnZXIuZGVidWcoYFNvY2tldCBkYXRhIHJlY2VpdmVkICgke2RhdGEubGVuZ3RofSBieXRlcylgKTtcbiAgICAgICAgICByZXNwb25zZS5hZGREYXRhKGRhdGEpO1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgLy8gd2hlbiBhbGwgZGF0YSBpcyBpbiwgZGVhbCB3aXRoIGl0XG4gICAgICAgIGNvbm4ub24oJ2VuZCcsICgpID0+IHtcbiAgICAgICAgICAvLyBpZiB3ZSBhcmUgbWlkd2F5IHRocm91Z2ggaGFuZGxpbmcgYSBjb21tYW5kXG4gICAgICAgICAgLy8gd2Ugd2FudCB0byB0cnkgb3V0IHRoZSBkYXRhLCBnZXR0aW5nIG1vcmUgaWYgbmVjZXNzYXJ5XG4gICAgICAgICAgaWYgKHRoaXMuY3VyQ29tbWFuZCkge1xuICAgICAgICAgICAgbGV0IHJlc3VsdCA9IHJlc3BvbnNlLmdldFJlc3VsdCgpO1xuICAgICAgICAgICAgaWYgKHJlc3VsdCAmJiAhcmVzdWx0Lm5lZWRzTW9yZURhdGEpIHtcbiAgICAgICAgICAgICAgLy8gaWYgd2UncmUgZG9uZSBhbHRvZ2V0aGVyLCBjYWxsIHRoZSBjYWxsYmFjayBhc3NvY2lhdGVkIHdpdGggdGhlIGNvbW1hbmRcbiAgICAgICAgICAgICAgdGhpcy5jdXJDb21tYW5kLmNiKHJlc3VsdCk7XG4gICAgICAgICAgICAgIHRoaXMuY3VyQ29tbWFuZCA9IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCdOb3QgdGhlIGxhc3QgY2h1bmssIHRyeWluZyB0byBnZXQgbW9yZScpO1xuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygnTm8gcmVzdWx0IHJlY2VpdmVkLiBDb250aW51aW5nIHRvIHRyeSB0byBnZXQgbW9yZScpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIC8vIGFkZCBhIGNvbW1hbmQgdG8gdGhlIHF1ZXVlLCB0byByZXF1ZXN0IG1vcmUgZGF0YVxuICAgICAgICAgICAgICB0aGlzLmNvbW1hbmRRdWV1ZS51bnNoaWZ0KHtjbWQ6IE1PUkVfQ09NTUFORCwgY2I6IHRoaXMuY3VyQ29tbWFuZC5jYn0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoJ0dvdCBhIHJlc3VsdCB3aGVuIHdlIHdlcmUgbm90IGV4cGVjdGluZyBvbmUhIElnbm9yaW5nIGl0Jyk7XG4gICAgICAgICAgICByZXNwb25zZS5yZXNldEJ1ZmZlcigpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIHNldCB1cCBhIGNhbGxiYWNrIHRvIGhhbmRsZSB0aGUgbmV4dCBjb21tYW5kXG4gICAgICAgICAgbGV0IG9uUmVjZWl2ZUNvbW1hbmQgPSAoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5jdXJDb21tYW5kID0gdGhpcy5jb21tYW5kUXVldWUuc2hpZnQoKTtcbiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIGluc3RydW1lbnRzOiAke3RoaXMuY3VyQ29tbWFuZC5jbWR9YCk7XG4gICAgICAgICAgICBjb25uLndyaXRlKEpTT04uc3RyaW5naWZ5KHtjbWQ6IHRoaXMuY3VyQ29tbWFuZC5jbWR9KSk7XG4gICAgICAgICAgICBjb25uLmVuZCgpO1xuICAgICAgICAgIH07XG4gICAgICAgICAgaWYgKHRoaXMuY29tbWFuZFF1ZXVlLmxlbmd0aCkge1xuICAgICAgICAgICAgb25SZWNlaXZlQ29tbWFuZCgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBvblJlY2VpdmVDb21tYW5kO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5zb2NrZXRTZXJ2ZXIub24oJ2Nsb3NlJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBsb2dnZXIuZGVidWcoJ0luc3RydW1lbnRzIHNvY2tldCBzZXJ2ZXIgd2FzIGNsb3NlZCcpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICAvLyByZW1vdmUgc29ja2V0IGZpbGUgaWYgaXQgY3VycmVudGx5IGV4aXN0c1xuICAgIGF3YWl0IGZzLnJpbXJhZih0aGlzLnNvY2spO1xuXG4gICAgLy8gY3JlYXRlIHRoZSBuZXcgc29ja2V0IGZpbGVcbiAgICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKHRoaXMuc29jaykpO1xuXG4gICAgdGhpcy5zb2NrZXRTZXJ2ZXIubGlzdGVuKHRoaXMuc29jayk7XG4gICAgbG9nZ2VyLmRlYnVnKGBJbnN0cnVtZW50cyBzb2NrZXQgc2VydmVyIHN0YXJ0ZWQgYXQgJHt0aGlzLnNvY2t9YCk7XG5cbiAgICByZXR1cm4gYXdhaXQgY29ubmVjdGVkUHJvbWlzZTtcbiAgfVxuXG4gIGFzeW5jIHNodXRkb3duICgpIHtcbiAgICAvLyBtYWtlIHN1cmUgY2xlYXIgb3V0IGNvbW1hbmQgY2JzIHNvIHdlIGNhbid0IGhhdmUgYW55IGxpbmdlcmluZyBjYnNcbiAgICAvLyBpZiBhIHNvY2tldCByZXF1ZXN0IG1ha2VzIGl0IHRocm91Z2ggYWZ0ZXIgZXhpdCBzb21laG93XG4gICAgdGhpcy5jdXJDb21tYW5kID0gbnVsbDtcbiAgICB0aGlzLm9uUmVjZWl2ZUNvbW1hbmQgPSBudWxsO1xuXG4gICAgaWYgKHRoaXMuY3VycmVudFNvY2tldCkge1xuICAgICAgbG9nZ2VyLmRlYnVnKCdEZXN0cm95aW5nIGluc3RydW1lbnRzIGNsaWVudCBzb2NrZXQuJyk7XG4gICAgICB0aGlzLmN1cnJlbnRTb2NrZXQuZW5kKCk7XG4gICAgICB0aGlzLmN1cnJlbnRTb2NrZXQuZGVzdHJveSgpO1xuICAgICAgdGhpcy5jdXJyZW50U29ja2V0ID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKHRoaXMuc29ja2V0U2VydmVyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0Nsb3Npbmcgc29ja2V0IHNlcnZlci4nKTtcbiAgICAgIGF3YWl0IChCLnByb21pc2lmeSh0aGlzLnNvY2tldFNlcnZlci5jbG9zZSwge2NvbnRleHQ6IHRoaXMuc29ja2V0U2VydmVyfSkpKCk7XG4gICAgICB0aGlzLnNvY2tldFNlcnZlciA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2FmZVNodXRkb3duICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ1NodXR0aW5nIGRvd24gY29tbWFuZCBwcm94eSBhbmQgaWdub3JpbmcgYW55IGVycm9ycycpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnNodXRkb3duKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYElnbm9yaW5nIGVycm9yOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgVUlBdXRvQ2xpZW50LCBERUZBVUxUX0lOU1RSVU1FTlRTX1NPQ0tFVCB9O1xuZXhwb3J0IGRlZmF1bHQgVUlBdXRvQ2xpZW50O1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
