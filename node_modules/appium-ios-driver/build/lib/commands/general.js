'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var _nodeSimctl = require('node-simctl');

var _moment = require('moment');

var _moment2 = _interopRequireDefault(_moment);

var commands = {},
    helpers = {},
    extensions = {};

var MOMENT_FORMAT_ISO8601 = 'YYYY-MM-DDTHH:mm:ssZ';

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

/**
 * Retrieves the current device's timestamp.
 *
 * @param {string} format - The set of format specifiers. Read
 *                          https://momentjs.com/docs/ to get the full list of supported
 *                          datetime format specifiers. The default format is
 *                          `YYYY-MM-DDTHH:mm:ssZ`, which complies to ISO-8601
 * @returns Formatted datetime string or the raw command output if formatting fails
 */
commands.getDeviceTime = function callee$0$0() {
  var format = arguments.length <= 0 || arguments[0] === undefined ? MOMENT_FORMAT_ISO8601 : arguments[0];
  var cmd, args, inputFormat, stdout, parsedTimestamp;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');
        cmd = undefined;
        args = undefined;
        inputFormat = undefined;

        if (!this.isRealDevice()) {
          context$1$0.next = 19;
          break;
        }

        context$1$0.prev = 5;
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 8:
        cmd = context$1$0.sent;
        context$1$0.next = 14;
        break;

      case 11:
        context$1$0.prev = 11;
        context$1$0.t0 = context$1$0['catch'](5);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 14:
        _logger2['default'].info('Found idevicedate: \'' + cmd + '\'');
        // https://github.com/libimobiledevice/libimobiledevice/blob/26373b334889f5ae2e2737ff447eb25b1700fa2f/tools/idevicedate.c#L129
        args = ['-u', this.opts.udid];
        inputFormat = 'ddd MMM DD HH:mm:ss z YYYY';
        context$1$0.next = 23;
        break;

      case 19:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        cmd = 'date';
        args = ['+%Y-%m-%dT%H:%M:%S%z'];
        inputFormat = MOMENT_FORMAT_ISO8601;

      case 23:
        context$1$0.next = 25;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(cmd, args));

      case 25:
        stdout = context$1$0.sent.stdout.trim();

        _logger2['default'].debug('Got the following output out of \'' + cmd + ' ' + args.join(' ') + '\': ' + stdout);
        parsedTimestamp = (0, _moment2['default'])(stdout, inputFormat);

        if (parsedTimestamp.isValid()) {
          context$1$0.next = 31;
          break;
        }

        _logger2['default'].warn('Cannot parse the timestamp \'' + stdout + '\' returned by \'' + cmd + '\' command. Returning it as is');
        return context$1$0.abrupt('return', stdout);

      case 31:
        return context$1$0.abrupt('return', parsedTimestamp.format(format));

      case 32:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[5, 11]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var script;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        script = 'return document.documentElement.outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.executeAtom('execute_script', [script, []]));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getNativePageSource());

      case 9:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 10:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

helpers.getNativePageSource = function callee$0$0() {
  var jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 2:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.stop());

      case 4:
        _logger2['default'].info('Successfully closed the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while closing the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.launchApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.start());

      case 4:
        _logger2['default'].info('Successfully launched the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while launching the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.realDevice.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.sim.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 16;
        break;

      case 10:
        if (_lodash2['default'].isArray(keys)) {
          keys = keys.join('');
        }
        if (!_lodash2['default'].isString(keys)) {
          keys = keys.toString();
        }
        keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

// For W3C
commands.getWindowRect = function callee$0$0() {
  var _ref, width, height;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.getWindowSize());

      case 2:
        _ref = context$1$0.sent;
        width = _ref.width;
        height = _ref.height;
        return context$1$0.abrupt('return', {
          width: width,
          height: height,
          x: 0,
          y: 0
        });

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setUrl = function callee$0$0(url) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Attempting to set url \'' + url + '\'');

        if (this.isWebContext()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, url));

      case 4:
        return context$1$0.abrupt('return');

      case 5:
        this.setCurrentUrl(url);
        // make sure to clear out any leftover web frames
        this.curWebFrames = [];
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.remote.navToUrl(url));

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
// use xcrun to open deeplink
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNGLGdCQUFnQjs7NEJBQ3BCLGNBQWM7O3FCQUNqQixVQUFVOzs7OzBCQUNKLGFBQWE7O3NCQUNsQixRQUFROzs7O0FBRTNCLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELElBQU0scUJBQXFCLEdBQUcsc0JBQXNCLENBQUM7O0FBRXJELFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7YUFDWixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7eUNBRXRDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDOzs7Ozs7Ozs7O0NBRXRFLENBQUM7Ozs7Ozs7Ozs7O0FBV0YsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUFnQixNQUFNLHlEQUFHLHFCQUFxQjtNQUVqRSxHQUFHLEVBQ0gsSUFBSSxFQUNKLFdBQVcsRUFrQlQsTUFBTSxFQUVOLGVBQWU7Ozs7QUF2QnJCLDRCQUFJLElBQUksQ0FBQyxnREFBZ0QsQ0FBQyxDQUFDO0FBQ3ZELFdBQUc7QUFDSCxZQUFJO0FBQ0osbUJBQVc7O2FBQ1gsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Ozt5Q0FFUCxrQkFBRyxLQUFLLENBQUMsYUFBYSxDQUFDOzs7QUFBbkMsV0FBRzs7Ozs7Ozs7QUFFSCw0QkFBSSxhQUFhLENBQUMsNkVBQTZFLEdBQzdFLDRDQUE0QyxDQUFDLENBQUM7OztBQUVsRSw0QkFBSSxJQUFJLDJCQUF3QixHQUFHLFFBQUksQ0FBQzs7QUFFeEMsWUFBSSxHQUFHLENBQUMsSUFBSSxFQUFFLElB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O0FBRXhCLFlBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxDQUFDOzt5Q0FDakIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDOzs7Ozs7O0NBQ2hDLENBQUM7O0FBR0YsZUFBYyxVQUFVLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tIFwianMyeG1scGFyc2VyMlwiO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB1dGlscyBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBvcGVuVXJsIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IE1PTUVOVF9GT1JNQVRfSVNPODYwMSA9ICdZWVlZLU1NLUREVEhIOm1tOnNzWic7XG5cbmNvbW1hbmRzLmFjdGl2ZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnYWN0aXZlX2VsZW1lbnQnLCBbXSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFwiYXUuZ2V0QWN0aXZlRWxlbWVudCgpXCIpO1xuICB9XG59O1xuXG4vKipcbiAqIFJldHJpZXZlcyB0aGUgY3VycmVudCBkZXZpY2UncyB0aW1lc3RhbXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGZvcm1hdCAtIFRoZSBzZXQgb2YgZm9ybWF0IHNwZWNpZmllcnMuIFJlYWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBodHRwczovL21vbWVudGpzLmNvbS9kb2NzLyB0byBnZXQgdGhlIGZ1bGwgbGlzdCBvZiBzdXBwb3J0ZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRldGltZSBmb3JtYXQgc3BlY2lmaWVycy4gVGhlIGRlZmF1bHQgZm9ybWF0IGlzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgYFlZWVktTU0tRERUSEg6bW06c3NaYCwgd2hpY2ggY29tcGxpZXMgdG8gSVNPLTg2MDFcbiAqIEByZXR1cm5zIEZvcm1hdHRlZCBkYXRldGltZSBzdHJpbmcgb3IgdGhlIHJhdyBjb21tYW5kIG91dHB1dCBpZiBmb3JtYXR0aW5nIGZhaWxzXG4gKi9cbmNvbW1hbmRzLmdldERldmljZVRpbWUgPSBhc3luYyBmdW5jdGlvbiAoZm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxKSB7XG4gIGxvZy5pbmZvKCdBdHRlbXB0aW5nIHRvIGNhcHR1cmUgaU9TIGRldmljZSBkYXRlIGFuZCB0aW1lJyk7XG4gIGxldCBjbWQ7XG4gIGxldCBhcmdzO1xuICBsZXQgaW5wdXRGb3JtYXQ7XG4gIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNtZCA9IGF3YWl0IGZzLndoaWNoKCdpZGV2aWNlZGF0ZScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coJ0NvdWxkIG5vdCBjYXB0dXJlIGRldmljZSBkYXRlIGFuZCB0aW1lIHVzaW5nIGxpYmltb2JpbGVkZXZpY2UgaWRldmljZWRhdGUuICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ0xpYmltb2JpbGVkZXZpY2UgaXMgcHJvYmFibHkgbm90IGluc3RhbGxlZCcpO1xuICAgIH1cbiAgICBsb2cuaW5mbyhgRm91bmQgaWRldmljZWRhdGU6ICcke2NtZH0nYCk7XG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2xpYmltb2JpbGVkZXZpY2UvbGliaW1vYmlsZWRldmljZS9ibG9iLzI2MzczYjMzNDg4OWY1YWUyZTI3MzdmZjQ0N2ViMjViMTcwMGZhMmYvdG9vbHMvaWRldmljZWRhdGUuYyNMMTI5XG4gICAgYXJncyA9IFsnLXUnLCB0aGlzLm9wdHMudWRpZF07XG4gICAgaW5wdXRGb3JtYXQgPSAnZGRkIE1NTSBERCBISDptbTpzcyB6IFlZWVknO1xuICB9IGVsc2Uge1xuICAgIGxvZy53YXJuKCdPbiBzaW11bGF0b3IuIEFzc3VtaW5nIGRldmljZSB0aW1lIGlzIHRoZSBzYW1lIGFzIGhvc3QgdGltZScpO1xuICAgIGNtZCA9ICdkYXRlJztcbiAgICBhcmdzID0gWycrJVktJW0tJWRUJUg6JU06JVMleiddO1xuICAgIGlucHV0Rm9ybWF0ID0gTU9NRU5UX0ZPUk1BVF9JU084NjAxO1xuICB9XG4gIGNvbnN0IHN0ZG91dCA9IChhd2FpdCBleGVjKGNtZCwgYXJncykpLnN0ZG91dC50cmltKCk7XG4gIGxvZy5kZWJ1ZyhgR290IHRoZSBmb2xsb3dpbmcgb3V0cHV0IG91dCBvZiAnJHtjbWR9ICR7YXJncy5qb2luKCcgJyl9JzogJHtzdGRvdXR9YCk7XG4gIGNvbnN0IHBhcnNlZFRpbWVzdGFtcCA9IG1vbWVudChzdGRvdXQsIGlucHV0Rm9ybWF0KTtcbiAgaWYgKCFwYXJzZWRUaW1lc3RhbXAuaXNWYWxpZCgpKSB7XG4gICAgbG9nLndhcm4oYENhbm5vdCBwYXJzZSB0aGUgdGltZXN0YW1wICcke3N0ZG91dH0nIHJldHVybmVkIGJ5ICcke2NtZH0nIGNvbW1hbmQuIFJldHVybmluZyBpdCBhcyBpc2ApO1xuICAgIHJldHVybiBzdGRvdXQ7XG4gIH1cbiAgcmV0dXJuIHBhcnNlZFRpbWVzdGFtcC5mb3JtYXQoZm9ybWF0KTtcbn07XG5cbmNvbW1hbmRzLmhpZGVLZXlib2FyZCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgLi4ucG9zc2libGVLZXlzKSB7XG4gIHBvc3NpYmxlS2V5cy5wb3AoKTsgLy8gbGFzdCBwYXJhbWV0ZXIgaXMgdGhlIHNlc3Npb24gaWRcbiAgbGV0IGNtZDtcbiAgbGV0IGtleSA9IF8uZmluZChwb3NzaWJsZUtleXMsIChrKSA9PiB7cmV0dXJuIGs7fSk7XG4gIGlmIChrZXkpIHtcbiAgICBzdHJhdGVneSA9IHN0cmF0ZWd5IHx8ICdwcmVzc0tleSc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nLCAnJHtrZXl9JylgO1xuICB9IGVsc2Uge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ2RlZmF1bHQnO1xuICAgIGNtZCA9IGBhdS5oaWRlS2V5Ym9hcmQoJyR7c3RyYXRlZ3l9JylgO1xuICB9XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGNtZCk7XG59O1xuXG5jb21tYW5kcy5nZXRQYWdlU291cmNlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGNvbnN0IHNjcmlwdCA9ICdyZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lm91dGVySFRNTCc7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2V4ZWN1dGVfc2NyaXB0JywgW3NjcmlwdCwgW11dKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXROYXRpdmVQYWdlU291cmNlKCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZ2V0TmF0aXZlUGFnZVNvdXJjZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGpzb25Tb3VyY2UgPSBhd2FpdCB0aGlzLmdldFNvdXJjZUZvckVsZW1lbnRGb3JYTUwoKTtcbiAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAganNvblNvdXJjZSA9IEpTT04ucGFyc2UoanNvblNvdXJjZSk7XG4gIH1cbiAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgd3JhcEFycmF5OiB7ZW5hYmxlZDogZmFsc2UsIGVsZW1lbnROYW1lOiBcImVsZW1lbnRcIn0sXG4gICAgZGVjbGFyYXRpb246IHtpbmNsdWRlOiB0cnVlfSxcbiAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gIH0pO1xuICByZXR1cm4geG1sU291cmNlO1xufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgY2xvc2luZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2ltLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vbGV0IGhhc09wdGlvbnMgPSBhbHRpdHVkZSAhPT0gbnVsbCB8fCBob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwgfHwgdmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCB8fCBjb3Vyc2UgIT09IG51bGwgfHwgc3BlZWQgIT09IG51bGw7XG4gIC8vaWYgKGhhc09wdGlvbnMpIHtcbiAgICAvL2xldCBvcHRpb25zID0ge307XG4gICAgLy9pZiAoYWx0aXR1ZGUgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5hbHRpdHVkZSA9IGFsdGl0dWRlO1xuICAgIC8vfVxuICAgIC8vaWYgKGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmhvcml6b250YWxBY2N1cmFjeSA9IGhvcml6b250YWxBY2N1cmFjeTtcbiAgICAvL31cbiAgICAvL2lmICh2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMudmVydGljYWxBY2N1cmFjeSA9IHZlcnRpY2FsQWNjdXJhY3k7XG4gICAgLy99XG4gICAgLy9pZiAoY291cnNlICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuY291cnNlID0gY291cnNlO1xuICAgIC8vfVxuICAgIC8vaWYgKHNwZWVkICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuc3BlZWQgPSBzcGVlZDtcbiAgICAvL31cbiAgICAvL2F3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFxuICAgICAgLy9gdGFyZ2V0LnNldExvY2F0aW9uV2l0aE9wdGlvbnMoJHtKU09OLnN0cmluZ2lmeShjb29yZGluYXRlcyl9LCAke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMpfSlgKTtcbiAgLy99IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy99XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZT1cImN1cnJlbnRcIikge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcihcIkN1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuXCIpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldFdpbmRvd1NpemUoKVwiKTtcbiAgfVxufTtcblxuLy8gRm9yIFczQ1xuY29tbWFuZHMuZ2V0V2luZG93UmVjdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3Qge3dpZHRoLCBoZWlnaHR9ID0gYXdhaXQgdGhpcy5nZXRXaW5kb3dTaXplKCk7XG4gIHJldHVybiB7XG4gICAgd2lkdGgsXG4gICAgaGVpZ2h0LFxuICAgIHg6IDAsXG4gICAgeTogMFxuICB9O1xufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgc3RyaW5nRmlsZSA9IG51bGwpIHtcbiAgbG9nLmRlYnVnKGBHZXR0aW5ncyBzdHJpbmdzIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nIGFuZCBzdHJpbmcgZmlsZSAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgbGV0IHN0cmluZ3MgPSBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhfLmRlZmF1bHRzKHtsYW5ndWFnZSwgc3RyaW5nRmlsZX0sIHRoaXMub3B0cykpO1xuICBpZiAoc3RyaW5ncyAmJiBzdHJpbmdzLmxlbmd0aCA+PSAxKSB7XG4gICAgc3RyaW5ncyA9IHN0cmluZ3NbMF07XG4gIH1cbiAgcmV0dXJuIHN0cmluZ3M7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGxvZy5kZWJ1ZyhgQXR0ZW1wdGluZyB0byBzZXQgdXJsICcke3VybH0nYCk7XG4gIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIC8vIHVzZSB4Y3J1biB0byBvcGVuIGRlZXBsaW5rXG4gICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCB1cmwpO1xuICAgIHJldHVybjtcbiAgfVxuICB0aGlzLnNldEN1cnJlbnRVcmwodXJsKTtcbiAgLy8gbWFrZSBzdXJlIHRvIGNsZWFyIG91dCBhbnkgbGVmdG92ZXIgd2ViIGZyYW1lc1xuICB0aGlzLmN1cldlYkZyYW1lcyA9IFtdO1xuICBhd2FpdCB0aGlzLnJlbW90ZS5uYXZUb1VybCh1cmwpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
