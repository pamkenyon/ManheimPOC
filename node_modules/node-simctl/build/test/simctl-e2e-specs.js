/* global it:true, describe:true*/
require('source-map-support').install();

'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _Object$keys = require('babel-runtime/core-js/object/keys')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _libSimctlJs = require('../lib/simctl.js');

var _appiumXcode = require('appium-xcode');

var _appiumXcode2 = _interopRequireDefault(_appiumXcode);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _appiumSupport = require('appium-support');

var _asyncbox = require('asyncbox');

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('simctl', function () {
  var DEVICE_NAME = 'iPhone 6';
  var MOCHA_TIMEOUT = 200000;
  this.timeout(MOCHA_TIMEOUT);

  var randName = undefined;
  var randDeviceUdid = null;
  var validSdks = [];

  before(function callee$1$0() {
    var devices, i, randNum, nameFound, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, list;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 2:
          devices = context$2$0.sent;

          validSdks = _lodash2['default'].keys(devices).sort(function (a, b) {
            return a - b;
          });

          if (validSdks.length) {
            context$2$0.next = 6;
            break;
          }

          throw new Error('No valid SDKs');

        case 6:
          console.log('Found valid SDKs: ' + validSdks.join(', ')); // eslint-disable-line no-console

          // need to find a random name that does not already exist
          // give it 5 tries
          i = 0;

        case 8:
          if (!(i < 5)) {
            context$2$0.next = 44;
            break;
          }

          randNum = parseInt(Math.random() * 100, 10);

          randName = 'device' + randNum;

          nameFound = false;
          _iteratorNormalCompletion = true;
          _didIteratorError = false;
          _iteratorError = undefined;
          context$2$0.prev = 15;
          _iterator = _getIterator(_lodash2['default'].values(devices));

        case 17:
          if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
            context$2$0.next = 25;
            break;
          }

          list = _step.value;

          if (!_lodash2['default'].includes(_lodash2['default'].map(list, 'name'), randName)) {
            context$2$0.next = 22;
            break;
          }

          // need to find another random name
          nameFound = true;
          return context$2$0.abrupt('break', 25);

        case 22:
          _iteratorNormalCompletion = true;
          context$2$0.next = 17;
          break;

        case 25:
          context$2$0.next = 31;
          break;

        case 27:
          context$2$0.prev = 27;
          context$2$0.t0 = context$2$0['catch'](15);
          _didIteratorError = true;
          _iteratorError = context$2$0.t0;

        case 31:
          context$2$0.prev = 31;
          context$2$0.prev = 32;

          if (!_iteratorNormalCompletion && _iterator['return']) {
            _iterator['return']();
          }

        case 34:
          context$2$0.prev = 34;

          if (!_didIteratorError) {
            context$2$0.next = 37;
            break;
          }

          throw _iteratorError;

        case 37:
          return context$2$0.finish(34);

        case 38:
          return context$2$0.finish(31);

        case 39:
          if (nameFound) {
            context$2$0.next = 41;
            break;
          }

          return context$2$0.abrupt('break', 44);

        case 41:
          i++;
          context$2$0.next = 8;
          break;

        case 44:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[15, 27, 31, 39], [32,, 34, 38]]);
  });

  // eslint-disable-line curly
  it('should create a device', function callee$1$0() {
    var udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)(randName, DEVICE_NAME, _lodash2['default'].last(validSdks)));

        case 2:
          udid = context$2$0.sent;

          (typeof udid).should.equal('string');
          udid.length.should.equal(36);

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should get devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 2:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.include(randName);
          randDeviceUdid = sdkDevices.filter(function (d) {
            return d.name === randName;
          })[0].udid;

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should erase devices', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.eraseDevice)(randDeviceUdid, 16000));

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should delete devices', function callee$1$0() {
    var sdkDevices;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(randDeviceUdid));

        case 2:
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)(_lodash2['default'].last(validSdks)));

        case 4:
          sdkDevices = context$2$0.sent;

          _lodash2['default'].map(sdkDevices, 'name').should.not.include(randName);

        case 6:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should return a nice error for invalid usage', function callee$1$0() {
    var err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          err = null;
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('foo', 'bar', 'baz'));

        case 4:
          context$2$0.next = 9;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          err = context$2$0.t0;

        case 9:
          should.exist(err);
          err.message.should.include('Invalid device type: bar');

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this, [[1, 6]]);
  });

  it('should create a device and be able to see it in devices list right away', function callee$1$0() {
    var sdk, numSimsBefore, udid, numSimsAfter;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          numSimsBefore = context$2$0.sent[context$2$0.t0].length;
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 7:
          udid = context$2$0.sent;
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 10:
          context$2$0.t1 = sdk;
          numSimsAfter = context$2$0.sent[context$2$0.t1].length;

          numSimsAfter.should.equal(numSimsBefore + 1);
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

        case 15:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should create a device with compatible properties', function callee$1$0() {
    var sdk, devices, firstDevice, expectedList;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.getDevices)());

        case 3:
          context$2$0.t0 = sdk;
          devices = context$2$0.sent[context$2$0.t0];
          firstDevice = devices[0];
          expectedList = ['name', 'sdk', 'state', 'udid'];

          _Object$keys(firstDevice).sort().should.eql(expectedList);

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  it('should not fail to shutdown a shutdown simulator', function callee$1$0() {
    var sdk, udid;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          sdk = _lodash2['default'].last(validSdks);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('node-simctl test', DEVICE_NAME, sdk));

        case 3:
          udid = context$2$0.sent;
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid).should.eventually.not.be.rejected);

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, this);
  });

  describe('on running Simulator', function () {
    if (process.env.TRAVIS) {
      this.retries(3);
    }

    var udid = undefined;
    var major = undefined,
        minor = undefined;

    before(function callee$2$0() {
      var _ref, sdk;

      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap(_appiumXcode2['default'].getVersion(true));

          case 2:
            _ref = context$3$0.sent;
            major = _ref.major;
            minor = _ref.minor;

            if (!(major < 8 || major === 8 && minor < 1)) {
              context$3$0.next = 7;
              break;
            }

            return context$3$0.abrupt('return', this.skip());

          case 7:
            sdk = _lodash2['default'].last(validSdks);
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.createDevice)('runningSimTest', DEVICE_NAME, sdk));

          case 10:
            udid = context$3$0.sent;
            context$3$0.next = 13;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.bootDevice)(udid));

          case 13:
            context$3$0.next = 15;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.launch)(udid, 'com.apple.springboard', MOCHA_TIMEOUT));

          case 15:
            context$3$0.next = 17;
            return _regeneratorRuntime.awrap(_bluebird2['default'].delay(5000));

          case 17:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
    after(function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            if (!udid) {
              context$3$0.next = 10;
              break;
            }

            context$3$0.prev = 1;
            context$3$0.next = 4;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.shutdown)(udid));

          case 4:
            context$3$0.next = 8;
            break;

          case 6:
            context$3$0.prev = 6;
            context$3$0.t0 = context$3$0['catch'](1);

          case 8:
            context$3$0.next = 10;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.deleteDevice)(udid));

          case 10:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this, [[1, 6]]);
    });

    describe('pasteboard', function () {
      var pbRetries = 0;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              if (!(major === 9)) {
                context$4$0.next = 7;
                break;
              }

              if (!process.env.TRAVIS) {
                context$4$0.next = 5;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 5:
              // TODO: recheck when full Xcode 9 comes out to see if pasteboard works better
              pbRetries = 200;
              this.timeout(200 * 1000 * 2);

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should set and get the content of the pasteboard', function callee$3$0() {
        var pbContent, encoding;
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          var _this = this;

          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              pbContent = 'blablabla';
              encoding = 'ascii';
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.setPasteboard)(udid, pbContent, encoding));

            case 4:
              context$4$0.next = 6;
              return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(pbRetries, 1000, function callee$4$0() {
                return _regeneratorRuntime.async(function callee$4$0$(context$5$0) {
                  while (1) switch (context$5$0.prev = context$5$0.next) {
                    case 0:
                      context$5$0.next = 2;
                      return _regeneratorRuntime.awrap((0, _libSimctlJs.getPasteboard)(udid, encoding));

                    case 2:
                      context$5$0.t0 = pbContent;
                      context$5$0.sent.should.eql(context$5$0.t0);

                    case 4:
                    case 'end':
                      return context$5$0.stop();
                  }
                }, null, _this);
              }));

            case 6:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    describe('add media', function () {
      var BASE64_PNG = 'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
      var picturePath = undefined;
      before(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              if (!(major < 8 || major === 8 && minor < 1)) {
                context$4$0.next = 2;
                break;
              }

              return context$4$0.abrupt('return', this.skip());

            case 2:
              context$4$0.next = 4;
              return _regeneratorRuntime.awrap(_appiumSupport.tempDir.path({ prefix: 'pixel', suffix: '.png' }));

            case 4:
              picturePath = context$4$0.sent;
              context$4$0.next = 7;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.writeFile(picturePath, Buffer.from(BASE64_PNG, 'base64').toString('binary'), 'binary'));

            case 7:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      after(function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(picturePath));

            case 2:
              if (!context$4$0.sent) {
                context$4$0.next = 5;
                break;
              }

              context$4$0.next = 5;
              return _regeneratorRuntime.awrap(_appiumSupport.fs.unlink(picturePath));

            case 5:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
      it('should add media files', function callee$3$0() {
        return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
          while (1) switch (context$4$0.prev = context$4$0.next) {
            case 0:
              context$4$0.next = 2;
              return _regeneratorRuntime.awrap((0, _libSimctlJs.addMedia)(udid, picturePath));

            case 2:
              context$4$0.sent.code.should.eql(0);

            case 3:
            case 'end':
              return context$4$0.stop();
          }
        }, null, this);
      });
    });

    it('should extract applications information', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return _regeneratorRuntime.awrap((0, _libSimctlJs.appInfo)(udid, 'com.apple.springboard'));

          case 2:
            context$3$0.sent.should.include('ApplicationType');

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, this);
    });
  });
});

// Wait for boot to complete

// pause a moment or everything is messed up
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc2ltY3RsLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O29CQUdpQixNQUFNOzs7OzhCQUNJLGtCQUFrQjs7OztzQkFDL0IsUUFBUTs7OzsyQkFFMEMsa0JBQWtCOzsyQkFDaEUsY0FBYzs7Ozt3QkFDbEIsVUFBVTs7Ozs2QkFDSSxnQkFBZ0I7O3dCQUNkLFVBQVU7O0FBR3hDLElBQU0sTUFBTSxHQUFHLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQzdCLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0FBRXpCLFFBQVEsQ0FBQyxRQUFRLEVBQUUsWUFBWTtBQUM3QixNQUFNLFdBQVcsR0FBRyxVQUFVLENBQUM7QUFDL0IsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDO0FBQzdCLE1BQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7O0FBRTVCLE1BQUksUUFBUSxZQUFBLENBQUM7QUFDYixNQUFJLGNBQWMsR0FBRyxJQUFJLENBQUM7QUFDMUIsTUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDOztBQUVuQixRQUFNLENBQUM7UUFDRCxPQUFPLEVBU0YsQ0FBQyxFQUNKLE9BQU8sRUFHUCxTQUFTLGtGQUNKLElBQUk7Ozs7OzsyQ0FkSyw4QkFBWTs7O0FBQTVCLGlCQUFPOztBQUNYLG1CQUFTLEdBQUcsb0JBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFDLENBQUMsRUFBRSxDQUFDO21CQUFLLENBQUMsR0FBRyxDQUFDO1dBQUEsQ0FBQyxDQUFDOztjQUM3QyxTQUFTLENBQUMsTUFBTTs7Ozs7Z0JBQ2IsSUFBSSxLQUFLLENBQUMsZUFBZSxDQUFDOzs7QUFFbEMsaUJBQU8sQ0FBQyxHQUFHLHdCQUFzQixTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFHLENBQUM7Ozs7QUFJaEQsV0FBQyxHQUFHLENBQUM7OztnQkFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFBOzs7OztBQUNmLGlCQUFPLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsR0FBRyxHQUFHLEVBQUUsRUFBRSxDQUFDOztBQUMvQyxrQkFBUSxjQUFZLE9BQU8sQUFBRSxDQUFDOztBQUUxQixtQkFBUyxHQUFHLEtBQUs7Ozs7O21DQUNKLG9CQUFFLE1BQU0sQ0FBQyxPQUFPLENBQUM7Ozs7Ozs7O0FBQXpCLGNBQUk7O2VBQ1Asb0JBQUUsUUFBUSxDQUFDLG9CQUFFLEdBQUcsQ0FBQyxJQUFJLEVBQUUsTUFBTSxDQUFDLEVBQUUsUUFBUSxDQUFDOzs7Ozs7QUFFM0MsbUJBQVMsR0FBRyxJQUFJLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Y0FJaEIsU0FBUzs7Ozs7Ozs7QUFaTyxXQUFDLEVBQUU7Ozs7Ozs7OztHQWMzQixDQUFDLENBQUM7OztBQUVILElBQUUsQ0FBQyx3QkFBd0IsRUFBRTtRQUN2QixJQUFJOzs7OzsyQ0FBUywrQkFBYSxRQUFRLEVBQUUsV0FBVyxFQUFFLG9CQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzs7O0FBQW5FLGNBQUk7O0FBQ1IsV0FBQyxPQUFPLElBQUksQ0FBQSxDQUFFLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDckMsY0FBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDOzs7Ozs7O0dBQzlCLENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsb0JBQW9CLEVBQUU7UUFDbkIsVUFBVTs7Ozs7MkNBQVMsNkJBQVcsb0JBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDOzs7QUFBaEQsb0JBQVU7O0FBQ2QsOEJBQUUsR0FBRyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ25ELHdCQUFjLEdBQUcsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFDLENBQUM7bUJBQUssQ0FBQyxDQUFDLElBQUksS0FBSyxRQUFRO1dBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQzs7Ozs7OztHQUN4RSxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHNCQUFzQixFQUFFOzs7OzsyQ0FDbkIsOEJBQVksY0FBYyxFQUFFLEtBQUssQ0FBQzs7Ozs7OztHQUN6QyxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHVCQUF1QixFQUFFO1FBRXRCLFVBQVU7Ozs7OzJDQURSLCtCQUFhLGNBQWMsQ0FBQzs7OzsyQ0FDWCw2QkFBVyxvQkFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7OztBQUFoRCxvQkFBVTs7QUFDZCw4QkFBRSxHQUFHLENBQUMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7Ozs7O0dBQ3hELENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsOENBQThDLEVBQUU7UUFDN0MsR0FBRzs7OztBQUFILGFBQUcsR0FBRyxJQUFJOzs7MkNBRU4sK0JBQWEsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUM7Ozs7Ozs7Ozs7QUFFdkMsYUFBRyxpQkFBSSxDQUFDOzs7QUFFVixnQkFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNsQixhQUFHLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsMEJBQTBCLENBQUMsQ0FBQzs7Ozs7OztHQUN4RCxDQUFDLENBQUM7O0FBRUgsSUFBRSxDQUFDLHlFQUF5RSxFQUFFO1FBQ3hFLEdBQUcsRUFDSCxhQUFhLEVBQ2IsSUFBSSxFQUNKLFlBQVk7Ozs7QUFIWixhQUFHLEdBQUcsb0JBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7MkNBQ0EsOEJBQVk7OzsyQkFBRSxHQUFHO0FBQXhDLHVCQUFhLG9DQUE2QixNQUFNOzsyQ0FDbkMsK0JBQWEsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLEdBQUcsQ0FBQzs7O0FBQS9ELGNBQUk7OzJDQUNrQiw4QkFBWTs7OzJCQUFFLEdBQUc7QUFBdkMsc0JBQVksb0NBQTZCLE1BQU07O0FBQ25ELHNCQUFZLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLENBQUM7OzJDQUN2QywrQkFBYSxJQUFJLENBQUM7Ozs7Ozs7R0FDekIsQ0FBQyxDQUFDOztBQUVILElBQUUsQ0FBQyxtREFBbUQsRUFBRTtRQUNsRCxHQUFHLEVBQ0gsT0FBTyxFQUNQLFdBQVcsRUFDWCxZQUFZOzs7O0FBSFosYUFBRyxHQUFHLG9CQUFFLElBQUksQ0FBQyxTQUFTLENBQUM7OzJDQUNOLDhCQUFZOzs7MkJBQUUsR0FBRztBQUFsQyxpQkFBTztBQUNQLHFCQUFXLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQztBQUN4QixzQkFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxDQUFDOztBQUNuRCx1QkFBWSxXQUFXLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDOzs7Ozs7O0dBQzFELENBQUMsQ0FBQzs7QUFFSCxJQUFFLENBQUMsa0RBQWtELEVBQUU7UUFDakQsR0FBRyxFQUNILElBQUk7Ozs7QUFESixhQUFHLEdBQUcsb0JBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7MkNBQ1YsK0JBQWEsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLEdBQUcsQ0FBQzs7O0FBQS9ELGNBQUk7OzJDQUNGLDJCQUFTLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxRQUFROzs7OzJDQUNoRCwrQkFBYSxJQUFJLENBQUM7Ozs7Ozs7R0FDekIsQ0FBQyxDQUFDOztBQUVILFVBQVEsQ0FBQyxzQkFBc0IsRUFBRSxZQUFZO0FBQzNDLFFBQUksT0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUU7QUFDdEIsVUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUNqQjs7QUFFRCxRQUFJLElBQUksWUFBQSxDQUFDO0FBQ1QsUUFBSSxLQUFLLFlBQUE7UUFBRSxLQUFLLFlBQUEsQ0FBQzs7QUFFakIsVUFBTSxDQUFDO2dCQU1DLEdBQUc7Ozs7Ozs2Q0FMZSx5QkFBTSxVQUFVLENBQUMsSUFBSSxDQUFDOzs7O0FBQTVDLGlCQUFLLFFBQUwsS0FBSztBQUFFLGlCQUFLLFFBQUwsS0FBSzs7a0JBQ1YsS0FBSyxHQUFHLENBQUMsSUFBSyxLQUFLLEtBQUssQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7Ozs7O2dEQUNsQyxJQUFJLENBQUMsSUFBSSxFQUFFOzs7QUFHZCxlQUFHLEdBQUcsb0JBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQzs7NkNBQ2hCLCtCQUFhLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxHQUFHLENBQUM7OztBQUE3RCxnQkFBSTs7NkNBRUUsNkJBQVcsSUFBSSxDQUFDOzs7OzZDQUVoQix5QkFBTyxJQUFJLEVBQUUsdUJBQXVCLEVBQUUsYUFBYSxDQUFDOzs7OzZDQUdwRCxzQkFBRSxLQUFLLENBQUMsSUFBSSxDQUFDOzs7Ozs7O0tBQ3BCLENBQUMsQ0FBQztBQUNILFNBQUssQ0FBQzs7OztpQkFDQSxJQUFJOzs7Ozs7OzZDQUVFLDJCQUFTLElBQUksQ0FBQzs7Ozs7Ozs7Ozs7OzZDQUVoQiwrQkFBYSxJQUFJLENBQUM7Ozs7Ozs7S0FFM0IsQ0FBQyxDQUFDOztBQUVILFlBQVEsQ0FBQyxZQUFZLEVBQUUsWUFBWTtBQUNqQyxVQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7QUFDbEIsWUFBTSxDQUFDOzs7O29CQUNELEtBQUssR0FBRyxDQUFDLElBQUssS0FBSyxLQUFLLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDOzs7OztrREFDbEMsSUFBSSxDQUFDLElBQUksRUFBRTs7O29CQUVoQixLQUFLLEtBQUssQ0FBQyxDQUFBOzs7OzttQkFDVCxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU07Ozs7O2tEQUNiLElBQUksQ0FBQyxJQUFJLEVBQUU7Ozs7QUFHcEIsdUJBQVMsR0FBRyxHQUFHLENBQUM7QUFDaEIsa0JBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQzs7Ozs7OztPQUVoQyxDQUFDLENBQUM7QUFDSCxRQUFFLENBQUMsa0RBQWtELEVBQUU7WUFDL0MsU0FBUyxFQUNULFFBQVE7Ozs7OztBQURSLHVCQUFTLEdBQUcsV0FBVztBQUN2QixzQkFBUSxHQUFHLE9BQU87OytDQUVsQixnQ0FBYyxJQUFJLEVBQUUsU0FBUyxFQUFFLFFBQVEsQ0FBQzs7OzsrQ0FDeEMsNkJBQWMsU0FBUyxFQUFFLElBQUksRUFBRTs7Ozs7dURBQzVCLGdDQUFjLElBQUksRUFBRSxRQUFRLENBQUM7Ozt1Q0FBYSxTQUFTO3VDQUFwQixNQUFNLENBQUMsR0FBRzs7Ozs7OztlQUNqRCxDQUFDOzs7Ozs7O09BQ0gsQ0FBQyxDQUFDO0tBQ0osQ0FBQyxDQUFDOztBQUVILFlBQVEsQ0FBQyxXQUFXLEVBQUUsWUFBWTtBQUNoQyxVQUFNLFVBQVUsR0FBRyxrR0FBa0csQ0FBQztBQUN0SCxVQUFJLFdBQVcsWUFBQSxDQUFDO0FBQ2hCLFlBQU0sQ0FBQzs7OztvQkFDRCxLQUFLLEdBQUcsQ0FBQyxJQUFLLEtBQUssS0FBSyxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQzs7Ozs7a0RBQ2xDLElBQUksQ0FBQyxJQUFJLEVBQUU7Ozs7K0NBRUEsdUJBQVEsSUFBSSxDQUFDLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDLENBQUM7OztBQUFuRSx5QkFBVzs7K0NBQ0wsa0JBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEVBQUUsUUFBUSxDQUFDOzs7Ozs7O09BQ2hHLENBQUMsQ0FBQztBQUNILFdBQUssQ0FBQzs7Ozs7K0NBQ00sa0JBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQzs7Ozs7Ozs7OytDQUN4QixrQkFBRyxNQUFNLENBQUMsV0FBVyxDQUFDOzs7Ozs7O09BRS9CLENBQUMsQ0FBQztBQUNILFFBQUUsQ0FBQyx3QkFBd0IsRUFBRTs7Ozs7K0NBQ3BCLDJCQUFTLElBQUksRUFBRSxXQUFXLENBQUM7OzsrQkFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDOzs7Ozs7O09BQ3RELENBQUMsQ0FBQztLQUNKLENBQUMsQ0FBQzs7QUFFSCxNQUFFLENBQUMseUNBQXlDLEVBQUU7Ozs7OzZDQUNyQywwQkFBUSxJQUFJLEVBQUUsdUJBQXVCLENBQUM7Ozs2QkFBRSxNQUFNLENBQUMsT0FBTyxDQUFDLGlCQUFpQjs7Ozs7OztLQUNoRixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoidGVzdC9zaW1jdGwtZTJlLXNwZWNzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIGl0OnRydWUsIGRlc2NyaWJlOnRydWUqL1xuLy8gdHJhbnNwaWxlOm1vY2hhXG5cbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGNyZWF0ZURldmljZSwgZGVsZXRlRGV2aWNlLCBlcmFzZURldmljZSwgZ2V0RGV2aWNlcywgc2V0UGFzdGVib2FyZCwgZ2V0UGFzdGVib2FyZCxcbiAgICAgICAgIGJvb3REZXZpY2UsIGxhdW5jaCwgc2h1dGRvd24sIGFkZE1lZGlhLCBhcHBJbmZvIH0gZnJvbSAnLi4vbGliL3NpbWN0bC5qcyc7XG5pbXBvcnQgeGNvZGUgZnJvbSAnYXBwaXVtLXhjb2RlJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGZzLCB0ZW1wRGlyIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcblxuXG5jb25zdCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5kZXNjcmliZSgnc2ltY3RsJywgZnVuY3Rpb24gKCkge1xuICBjb25zdCBERVZJQ0VfTkFNRSA9ICdpUGhvbmUgNic7XG4gIGNvbnN0IE1PQ0hBX1RJTUVPVVQgPSAyMDAwMDA7XG4gIHRoaXMudGltZW91dChNT0NIQV9USU1FT1VUKTtcblxuICBsZXQgcmFuZE5hbWU7XG4gIGxldCByYW5kRGV2aWNlVWRpZCA9IG51bGw7XG4gIGxldCB2YWxpZFNka3MgPSBbXTtcblxuICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBkZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcygpO1xuICAgIHZhbGlkU2RrcyA9IF8ua2V5cyhkZXZpY2VzKS5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgaWYgKCF2YWxpZFNka3MubGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZhbGlkIFNES3MnKTtcbiAgICB9XG4gICAgY29uc29sZS5sb2coYEZvdW5kIHZhbGlkIFNES3M6ICR7dmFsaWRTZGtzLmpvaW4oJywgJyl9YCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tY29uc29sZVxuXG4gICAgLy8gbmVlZCB0byBmaW5kIGEgcmFuZG9tIG5hbWUgdGhhdCBkb2VzIG5vdCBhbHJlYWR5IGV4aXN0XG4gICAgLy8gZ2l2ZSBpdCA1IHRyaWVzXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgIGxldCByYW5kTnVtID0gcGFyc2VJbnQoTWF0aC5yYW5kb20oKSAqIDEwMCwgMTApO1xuICAgICAgcmFuZE5hbWUgPSBgZGV2aWNlJHtyYW5kTnVtfWA7XG5cbiAgICAgIGxldCBuYW1lRm91bmQgPSBmYWxzZTtcbiAgICAgIGZvciAobGV0IGxpc3Qgb2YgXy52YWx1ZXMoZGV2aWNlcykpIHtcbiAgICAgICAgaWYgKF8uaW5jbHVkZXMoXy5tYXAobGlzdCwgJ25hbWUnKSwgcmFuZE5hbWUpKSB7XG4gICAgICAgICAgLy8gbmVlZCB0byBmaW5kIGFub3RoZXIgcmFuZG9tIG5hbWVcbiAgICAgICAgICBuYW1lRm91bmQgPSB0cnVlO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoIW5hbWVGb3VuZCkgYnJlYWs7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgY3VybHlcbiAgICB9XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY3JlYXRlIGEgZGV2aWNlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCB1ZGlkID0gYXdhaXQgY3JlYXRlRGV2aWNlKHJhbmROYW1lLCBERVZJQ0VfTkFNRSwgXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgICh0eXBlb2YgdWRpZCkuc2hvdWxkLmVxdWFsKCdzdHJpbmcnKTtcbiAgICB1ZGlkLmxlbmd0aC5zaG91bGQuZXF1YWwoMzYpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGdldCBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGtEZXZpY2VzID0gYXdhaXQgZ2V0RGV2aWNlcyhfLmxhc3QodmFsaWRTZGtzKSk7XG4gICAgXy5tYXAoc2RrRGV2aWNlcywgJ25hbWUnKS5zaG91bGQuaW5jbHVkZShyYW5kTmFtZSk7XG4gICAgcmFuZERldmljZVVkaWQgPSBzZGtEZXZpY2VzLmZpbHRlcigoZCkgPT4gZC5uYW1lID09PSByYW5kTmFtZSlbMF0udWRpZDtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBlcmFzZSBkZXZpY2VzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGF3YWl0IGVyYXNlRGV2aWNlKHJhbmREZXZpY2VVZGlkLCAxNjAwMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZGVsZXRlIGRldmljZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgZGVsZXRlRGV2aWNlKHJhbmREZXZpY2VVZGlkKTtcbiAgICBsZXQgc2RrRGV2aWNlcyA9IGF3YWl0IGdldERldmljZXMoXy5sYXN0KHZhbGlkU2RrcykpO1xuICAgIF8ubWFwKHNka0RldmljZXMsICduYW1lJykuc2hvdWxkLm5vdC5pbmNsdWRlKHJhbmROYW1lKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXR1cm4gYSBuaWNlIGVycm9yIGZvciBpbnZhbGlkIHVzYWdlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBlcnIgPSBudWxsO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjcmVhdGVEZXZpY2UoJ2ZvbycsICdiYXInLCAnYmF6Jyk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgZXJyID0gZTtcbiAgICB9XG4gICAgc2hvdWxkLmV4aXN0KGVycik7XG4gICAgZXJyLm1lc3NhZ2Uuc2hvdWxkLmluY2x1ZGUoJ0ludmFsaWQgZGV2aWNlIHR5cGU6IGJhcicpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSBhbmQgYmUgYWJsZSB0byBzZWUgaXQgaW4gZGV2aWNlcyBsaXN0IHJpZ2h0IGF3YXknLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgbGV0IHNkayA9IF8ubGFzdCh2YWxpZFNka3MpO1xuICAgIGxldCBudW1TaW1zQmVmb3JlID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbGV0IHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ25vZGUtc2ltY3RsIHRlc3QnLCBERVZJQ0VfTkFNRSwgc2RrKTtcbiAgICBsZXQgbnVtU2ltc0FmdGVyID0gKGF3YWl0IGdldERldmljZXMoKSlbc2RrXS5sZW5ndGg7XG4gICAgbnVtU2ltc0FmdGVyLnNob3VsZC5lcXVhbChudW1TaW1zQmVmb3JlICsgMSk7XG4gICAgYXdhaXQgZGVsZXRlRGV2aWNlKHVkaWQpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGNyZWF0ZSBhIGRldmljZSB3aXRoIGNvbXBhdGlibGUgcHJvcGVydGllcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBsZXQgc2RrID0gXy5sYXN0KHZhbGlkU2Rrcyk7XG4gICAgbGV0IGRldmljZXMgPSAoYXdhaXQgZ2V0RGV2aWNlcygpKVtzZGtdO1xuICAgIGxldCBmaXJzdERldmljZSA9IGRldmljZXNbMF07XG4gICAgbGV0IGV4cGVjdGVkTGlzdCA9IFsnbmFtZScsICdzZGsnLCAnc3RhdGUnLCAndWRpZCddO1xuICAgIE9iamVjdC5rZXlzKGZpcnN0RGV2aWNlKS5zb3J0KCkuc2hvdWxkLmVxbChleHBlY3RlZExpc3QpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIG5vdCBmYWlsIHRvIHNodXRkb3duIGEgc2h1dGRvd24gc2ltdWxhdG9yJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGxldCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICBsZXQgdWRpZCA9IGF3YWl0IGNyZWF0ZURldmljZSgnbm9kZS1zaW1jdGwgdGVzdCcsIERFVklDRV9OQU1FLCBzZGspO1xuICAgIGF3YWl0IHNodXRkb3duKHVkaWQpLnNob3VsZC5ldmVudHVhbGx5Lm5vdC5iZS5yZWplY3RlZDtcbiAgICBhd2FpdCBkZWxldGVEZXZpY2UodWRpZCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdvbiBydW5uaW5nIFNpbXVsYXRvcicsIGZ1bmN0aW9uICgpIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuVFJBVklTKSB7XG4gICAgICB0aGlzLnJldHJpZXMoMyk7XG4gICAgfVxuXG4gICAgbGV0IHVkaWQ7XG4gICAgbGV0IG1ham9yLCBtaW5vcjtcblxuICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoe21ham9yLCBtaW5vcn0gPSBhd2FpdCB4Y29kZS5nZXRWZXJzaW9uKHRydWUpKTtcbiAgICAgIGlmIChtYWpvciA8IDggfHwgKG1ham9yID09PSA4ICYmIG1pbm9yIDwgMSkpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzZGsgPSBfLmxhc3QodmFsaWRTZGtzKTtcbiAgICAgIHVkaWQgPSBhd2FpdCBjcmVhdGVEZXZpY2UoJ3J1bm5pbmdTaW1UZXN0JywgREVWSUNFX05BTUUsIHNkayk7XG5cbiAgICAgIGF3YWl0IGJvb3REZXZpY2UodWRpZCk7XG4gICAgICAvLyBXYWl0IGZvciBib290IHRvIGNvbXBsZXRlXG4gICAgICBhd2FpdCBsYXVuY2godWRpZCwgJ2NvbS5hcHBsZS5zcHJpbmdib2FyZCcsIE1PQ0hBX1RJTUVPVVQpO1xuXG4gICAgICAvLyBwYXVzZSBhIG1vbWVudCBvciBldmVyeXRoaW5nIGlzIG1lc3NlZCB1cFxuICAgICAgYXdhaXQgQi5kZWxheSg1MDAwKTtcbiAgICB9KTtcbiAgICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAodWRpZCkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHNodXRkb3duKHVkaWQpO1xuICAgICAgICB9IGNhdGNoIChpZ24pIHt9XG4gICAgICAgIGF3YWl0IGRlbGV0ZURldmljZSh1ZGlkKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdwYXN0ZWJvYXJkJywgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IHBiUmV0cmllcyA9IDA7XG4gICAgICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAobWFqb3IgPCA4IHx8IChtYWpvciA9PT0gOCAmJiBtaW5vciA8IDEpKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuc2tpcCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChtYWpvciA9PT0gOSkge1xuICAgICAgICAgIGlmIChwcm9jZXNzLmVudi5UUkFWSVMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNraXAoKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgLy8gVE9ETzogcmVjaGVjayB3aGVuIGZ1bGwgWGNvZGUgOSBjb21lcyBvdXQgdG8gc2VlIGlmIHBhc3RlYm9hcmQgd29ya3MgYmV0dGVyXG4gICAgICAgICAgcGJSZXRyaWVzID0gMjAwO1xuICAgICAgICAgIHRoaXMudGltZW91dCgyMDAgKiAxMDAwICogMik7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgaXQoJ3Nob3VsZCBzZXQgYW5kIGdldCB0aGUgY29udGVudCBvZiB0aGUgcGFzdGVib2FyZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc3QgcGJDb250ZW50ID0gJ2JsYWJsYWJsYSc7XG4gICAgICAgIGNvbnN0IGVuY29kaW5nID0gJ2FzY2lpJztcblxuICAgICAgICBhd2FpdCBzZXRQYXN0ZWJvYXJkKHVkaWQsIHBiQ29udGVudCwgZW5jb2RpbmcpO1xuICAgICAgICBhd2FpdCByZXRyeUludGVydmFsKHBiUmV0cmllcywgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIChhd2FpdCBnZXRQYXN0ZWJvYXJkKHVkaWQsIGVuY29kaW5nKSkuc2hvdWxkLmVxbChwYkNvbnRlbnQpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ2FkZCBtZWRpYScsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGNvbnN0IEJBU0U2NF9QTkcgPSAnaVZCT1J3MEtHZ29BQUFBTlNVaEVVZ0FBQUFFQUFBQUJDQVlBQUFBZkZjU0pBQUFBRFVsRVFWUjQybU5rK005UUR3QURoZ0dBV2pSOWF3QUFBQUJKUlU1RXJrSmdnZz09JztcbiAgICAgIGxldCBwaWN0dXJlUGF0aDtcbiAgICAgIGJlZm9yZShhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmIChtYWpvciA8IDggfHwgKG1ham9yID09PSA4ICYmIG1pbm9yIDwgMSkpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5za2lwKCk7XG4gICAgICAgIH1cbiAgICAgICAgcGljdHVyZVBhdGggPSBhd2FpdCB0ZW1wRGlyLnBhdGgoe3ByZWZpeDogJ3BpeGVsJywgc3VmZml4OiAnLnBuZyd9KTtcbiAgICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKHBpY3R1cmVQYXRoLCBCdWZmZXIuZnJvbShCQVNFNjRfUE5HLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpLCAnYmluYXJ5Jyk7XG4gICAgICB9KTtcbiAgICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKGF3YWl0IGZzLmV4aXN0cyhwaWN0dXJlUGF0aCkpIHtcbiAgICAgICAgICBhd2FpdCBmcy51bmxpbmsocGljdHVyZVBhdGgpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYWRkIG1lZGlhIGZpbGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAoYXdhaXQgYWRkTWVkaWEodWRpZCwgcGljdHVyZVBhdGgpKS5jb2RlLnNob3VsZC5lcWwoMCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZXh0cmFjdCBhcHBsaWNhdGlvbnMgaW5mb3JtYXRpb24nLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAoYXdhaXQgYXBwSW5mbyh1ZGlkLCAnY29tLmFwcGxlLnNwcmluZ2JvYXJkJykpLnNob3VsZC5pbmNsdWRlKCdBcHBsaWNhdGlvblR5cGUnKTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
